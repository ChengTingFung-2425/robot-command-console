name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v3.2.0)'
        required: true
        type: string

permissions:
  contents: read

env:
  PYTHON_VERSION: '3.12'

jobs:
  create-release:
    name: å»ºç«‹ Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      version: ${{ steps.get_version.outputs.version }}
    
    steps:
      - name: Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: å–å¾—ç‰ˆæœ¬è™Ÿ
        id: get_version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
      
      - name: è¨­å®š Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: å–å¾—ç‰ˆæœ¬è³‡è¨Š
        id: version_info
        run: |
          python src/common/version.py > version_info.json
          cat version_info.json
      
      - name: ç”Ÿæˆ Release Notes
        id: release_notes
        run: |
          cat > release_notes.md << 'EOF'
          ## Robot Command Console ${{ steps.get_version.outputs.version }}
          
          ### ðŸŽ‰ æ–°åŠŸèƒ½
          
          - âœ… Tiny Edge App - PyQt6 è¼•é‡ç´šæ¡Œé¢æ‡‰ç”¨
          - âœ… å®Œæ•´çš„å›ºä»¶æ›´æ–°ç®¡ç†ï¼ˆéžåŒæ­¥è™•ç†ï¼‰
          - âœ… å°ˆæ¥­çš„å•Ÿå‹•ç•«é¢èˆ‡ UI å„ªåŒ–
          - âœ… å®Œæ•´çš„å·¥å…·åˆ—åŠŸèƒ½ï¼ˆå…¨èž¢å¹•ã€å¹«åŠ©ã€é—œæ–¼ï¼‰
          - âœ… çµ±ä¸€çš„å¾Œç«¯æœå‹™ç®¡ç†
          
          ### ðŸ“¦ ä¸‹è¼‰
          
          è«‹å¾žä¸‹æ–¹é¸æ“‡é©åˆæ‚¨ä½œæ¥­ç³»çµ±çš„ç‰ˆæœ¬ï¼š
          - **Linux**: RobotConsole-linux.tar.gz
          - **Windows**: RobotConsole-windows.zip  
          - **macOS**: RobotConsole-macos.tar.gz
          
          ### ðŸ“‹ ç³»çµ±éœ€æ±‚
          
          - **ä½œæ¥­ç³»çµ±**: Windows 10+, macOS 12+, Ubuntu 22.04+
          - **è¨˜æ†¶é«”**: æœ€å° 4GB RAM
          - **å„²å­˜ç©ºé–“**: æœ€å° 200MB
          
          ### ðŸš€ å¿«é€Ÿé–‹å§‹
          
          1. ä¸‹è¼‰å°æ‡‰å¹³å°çš„å£“ç¸®æª”
          2. è§£å£“ç¸®
          3. åŸ·è¡Œ `RobotConsole` ä¸»ç¨‹å¼
          
          è©³ç´°å®‰è£èªªæ˜Žè«‹åƒé–± [README.md](https://github.com/ChengTingFung-2425/robot-command-console/blob/main/README.md)
          
          ### ðŸ”§ æŠ€è¡“å †ç–Š
          
          - **å‰ç«¯**: PyQt6 + QtWebEngine
          - **å¾Œç«¯**: Flask + Robot Service
          - **é€šè¨Š**: QWebChannel Bridge
          - **æ‰“åŒ…**: PyInstaller
          
          ### ðŸ“ å®Œæ•´è®Šæ›´è¨˜éŒ„
          
          è«‹åƒé–± [CHANGELOG.md](https://github.com/ChengTingFung-2425/robot-command-console/blob/main/CHANGELOG.md)
          
          ### ðŸ› å·²çŸ¥å•é¡Œ
          
          - macOS ç‰ˆæœ¬éœ€è¦åœ¨å®‰å…¨æ€§è¨­å®šä¸­å…è¨±åŸ·è¡Œï¼ˆé¦–æ¬¡å•Ÿå‹•ï¼‰
          - Windows Defender å¯èƒ½æœƒæ¨™è¨˜ç‚ºæœªçŸ¥æ‡‰ç”¨ç¨‹å¼ï¼ˆæ­£å¸¸ç¾è±¡ï¼‰
          
          ### ðŸ’¬ å›žé¥‹èˆ‡æ”¯æ´
          
          å¦‚é‡åˆ°å•é¡Œï¼Œè«‹åˆ° [Issues](https://github.com/ChengTingFung-2425/robot-command-console/issues) å›žå ±ã€‚
          EOF
          
          cat release_notes.md
      
      - name: å»ºç«‹ GitHub Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.get_version.outputs.version }}
          release_name: Release ${{ steps.get_version.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(steps.get_version.outputs.version, 'beta') || contains(steps.get_version.outputs.version, 'alpha') }}
  
  build-and-upload:
    name: æ§‹å»ºä¸¦ä¸Šå‚³ - ${{ matrix.os }}
    needs: create-release
    runs-on: ${{ matrix.os }}
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            platform: linux
            artifact_name: RobotConsole-linux
            asset_name: RobotConsole-linux.tar.gz
            asset_content_type: application/gzip
          - os: windows-latest
            platform: windows
            artifact_name: RobotConsole-windows
            asset_name: RobotConsole-windows.zip
            asset_content_type: application/zip
          - os: macos-latest
            platform: macos
            artifact_name: RobotConsole-macos
            asset_name: RobotConsole-macos.tar.gz
            asset_content_type: application/gzip
    
    steps:
      - name: Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4
      
      - name: è¨­å®š Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: å®‰è£ç³»çµ±ä¾è³´ (Ubuntu)
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libxcb-xinerama0 libxcb-cursor0 libxkbcommon-x11-0 \
            libgl1-mesa-glx libdbus-1-3 libegl1
      
      - name: å®‰è£ Python ä¾è³´
        run: |
          pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt
          pip install pyinstaller pillow
      
      - name: å»ºç«‹å•Ÿå‹•ç•«é¢
        run: |
          python Edge/qtwebview-app/resources/images/create_splash_image.py
      
      - name: æ‰“åŒ…æ‡‰ç”¨ç¨‹å¼
        run: |
          pyinstaller Edge/qtwebview-app/build.spec
      
      - name: å»ºç«‹ç™¼ä½ˆå£“ç¸®æª”
        shell: bash
        run: |
          cd dist
          if [ "${{ matrix.platform }}" == "windows" ]; then
            7z a -tzip ${{ matrix.asset_name }} RobotConsole/
          else
            tar -czf ${{ matrix.asset_name }} RobotConsole/
          fi
          ls -lh ${{ matrix.asset_name }}
      
      - name: ä¸Šå‚³ Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: ./dist/${{ matrix.asset_name }}
          asset_name: ${{ matrix.asset_name }}
          asset_content_type: ${{ matrix.asset_content_type }}
