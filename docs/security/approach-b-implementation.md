# æ–¹æ¡ˆ B å¯¦ä½œï¼šToken å¿«å–åŒæ­¥èªè­‰æ¶æ§‹

> **é–‹å§‹æ—¥æœŸ**ï¼š2025-12-17  
> **ç‹€æ…‹**ï¼šğŸš§ Phase 1 é€²è¡Œä¸­  
> **æ–¹æ¡ˆ**ï¼šæ–¹æ¡ˆ B - Token å¿«å–åŒæ­¥ï¼ˆè©³è¦‹ edge-cloud-auth-analysis.mdï¼‰

## å¯¦ä½œé€²åº¦

### âœ… Phase 1ï¼šServer ç«¯èªè­‰ APIï¼ˆå·²å®Œæˆï¼‰

**ç›®æ¨™**ï¼šå¯¦ä½œé›²ç«¯èªè­‰ APIï¼Œæ”¯æ´ JWT token ç™¼æ”¾èˆ‡ç®¡ç†

**å·²å®Œæˆ**ï¼š

#### 1. èªè­‰ API æ¨¡çµ„ (`WebUI/app/auth_api.py`)

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- `/api/auth/login` - ç™»å…¥ç«¯é»
- `/api/auth/refresh` - Token æ›´æ–°ç«¯é»
- `/api/auth/verify` - Token é©—è­‰ç«¯é»
- `/api/auth/revoke` - Token æ’¤éŠ·ï¼ˆç™»å‡ºï¼‰
- `/api/auth/me` - å–å¾—ç•¶å‰ä½¿ç”¨è€…è³‡è¨Š

**Token ç­–ç•¥**ï¼š
- Access Tokenï¼š15 åˆ†é˜æœ‰æ•ˆæœŸ
- Refresh Tokenï¼š7 å¤©æœ‰æ•ˆæœŸï¼Œè¨­å‚™ç¶å®š
- JWT ç°½åï¼šä½¿ç”¨ HS256 æ¼”ç®—æ³•
- Device IDï¼šç”¨æ–¼ç¶å®šè¨­å‚™ï¼Œé˜²æ­¢è·¨è¨­å‚™ä½¿ç”¨

**å®‰å…¨ç‰¹æ€§**ï¼š
- âœ… å¯†ç¢¼é©—è­‰åœ¨ Server ç«¯åŸ·è¡Œ
- âœ… Token åŒ…å«ä½¿ç”¨è€…è§’è‰²ï¼ˆæ”¯æ´æ¬Šé™è®Šæ›´åŒæ­¥ï¼‰
- âœ… Device ID ç¶å®šé˜²æ­¢ token è¢«ç›œç”¨
- âœ… çŸ­æœŸ Access Token æ¸›å°‘é¢¨éšª
- âœ… å¯©è¨ˆæ—¥èªŒè¨˜éŒ„æ‰€æœ‰èªè­‰äº‹ä»¶

**API ç¯„ä¾‹**ï¼š

```bash
# ç™»å…¥
curl -X POST http://localhost:5000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin",
    "password": "password123"
  }'

# å›æ‡‰
{
  "success": true,
  "access_token": "eyJ0eXAiOiJKV1QiLCJhbGc...",
  "refresh_token": "eyJ0eXAiOiJKV1QiLCJhbGc...",
  "user": {
    "id": 1,
    "username": "admin",
    "email": "admin@example.com",
    "role": "admin"
  },
  "device_id": "abc123...",
  "expires_in": 900
}

# æ›´æ–° Token
curl -X POST http://localhost:5000/api/auth/refresh \
  -H "Content-Type: application/json" \
  -d '{
    "refresh_token": "eyJ0eXAiOiJKV1QiLCJhbGc..."
  }'

# é©—è­‰ Token
curl -X POST http://localhost:5000/api/auth/verify \
  -H "Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGc..."

# å–å¾—ç•¶å‰ä½¿ç”¨è€…
curl -X GET http://localhost:5000/api/auth/me \
  -H "Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGc..."

# ç™»å‡º
curl -X POST http://localhost:5000/api/auth/revoke \
  -H "Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGc..."
```

#### 2. Token å·¥å…·å‡½æ•¸

**å¯¦ä½œçš„å‡½æ•¸**ï¼š
- `create_access_token(user_id, role)` - å»ºç«‹çŸ­æœŸ Access Token
- `create_refresh_token(user_id, device_id)` - å»ºç«‹é•·æœŸ Refresh Tokenï¼ˆè¨­å‚™ç¶å®šï¼‰
- `verify_token(token, token_type)` - é©—è­‰ token ä¸¦è¿”å› payload
- `token_required(allow_offline)` - Token é©—è­‰è£é£¾å™¨
- `generate_device_id()` - ç”Ÿæˆå”¯ä¸€è¨­å‚™ ID
- `get_device_fingerprint(request)` - å¾è«‹æ±‚æå–è¨­å‚™æŒ‡ç´‹

**JWT Payload çµæ§‹**ï¼š

```python
# Access Token
{
  "user_id": 1,
  "role": "admin",
  "type": "access",
  "exp": 1234567890,  # 15 åˆ†é˜å¾Œ
  "iat": 1234567000
}

# Refresh Token
{
  "user_id": 1,
  "device_id": "abc123...",
  "type": "refresh",
  "exp": 1235177000,  # 7 å¤©å¾Œ
  "iat": 1234567000
}
```

#### 3. æ•´åˆè‡³ Flask App

**è®Šæ›´**ï¼š
- `WebUI/app/__init__.py`ï¼šè¨»å†Š `auth_api_bp` Blueprint
- æ‰€æœ‰ç«¯é»å‰ç¶´ï¼š`/api/auth/*`

#### 4. æ¸¬è©¦å¥—ä»¶ (`tests/test_auth_api.py`)

**æ¸¬è©¦æ¶µè“‹**ï¼š
- âœ… ç™»å…¥æˆåŠŸï¼ˆ14 å€‹æ¸¬è©¦ï¼‰
- âœ… ç™»å…¥å¤±æ•—ï¼ˆç„¡æ•ˆæ†‘è­‰ã€ç¼ºå°‘æ¬„ä½ï¼‰
- âœ… Token æ›´æ–°ï¼ˆæˆåŠŸã€å¤±æ•—ï¼‰
- âœ… Token é©—è­‰ï¼ˆæˆåŠŸã€å¤±æ•—ï¼‰
- âœ… å–å¾—ç•¶å‰ä½¿ç”¨è€…è³‡è¨Š
- âœ… Token æ’¤éŠ·ï¼ˆç™»å‡ºï¼‰
- âœ… è‡ªè¨‚ device_id
- âœ… Token å·¥å…·å‡½æ•¸ï¼ˆå»ºç«‹ã€é©—è­‰ã€é¡å‹æª¢æŸ¥ï¼‰

**æ¸¬è©¦ç‹€æ…‹**ï¼š
- CI ç’°å¢ƒæœƒè·³éï¼ˆç„¡ WebUI ä¾è³´ï¼‰
- æœ¬åœ°ç’°å¢ƒå®Œæ•´æ¸¬è©¦é€šé

#### 5. å¯©è¨ˆæ—¥èªŒæ•´åˆ

**è¨˜éŒ„çš„äº‹ä»¶**ï¼š
- `api_login_success` - API ç™»å…¥æˆåŠŸ
- `login_failure` - ç™»å…¥å¤±æ•—
- `token_refresh_success` - Token æ›´æ–°æˆåŠŸ
- `token_refresh_failure` - Token æ›´æ–°å¤±æ•—
- `api_logout` - API ç™»å‡º

**è¨˜éŒ„å…§å®¹**ï¼š
- ä½¿ç”¨è€… ID
- Device IDï¼ˆå‰ 8 å­—å…ƒï¼‰
- ç™»å…¥æ–¹æ³•ï¼ˆapiï¼‰
- IP ä½å€ï¼ˆè‡ªå‹•ï¼‰
- User-Agentï¼ˆè‡ªå‹•ï¼‰

### ğŸ“Š Phase 1 çµ±è¨ˆ

**æ–°å¢ç¨‹å¼ç¢¼**ï¼š
- `WebUI/app/auth_api.py`ï¼š~330 è¡Œ
- `tests/test_auth_api.py`ï¼š~300 è¡Œ
- ä¿®æ”¹ `WebUI/app/__init__.py`ï¼š3 è¡Œ

**API ç«¯é»**ï¼š5 å€‹
**æ¸¬è©¦æ¡ˆä¾‹**ï¼š14 å€‹
**å®‰å…¨ç‰¹æ€§**ï¼š6 å€‹

### ğŸ”„ ä¸‹ä¸€éšæ®µï¼šPhase 2 - Edge ç«¯ Token å¿«å–

**è¨ˆç•«**ï¼š
1. å»ºç«‹ `EdgeAuthCache` é¡åˆ¥ï¼ˆ`src/robot_service/auth/edge_auth_cache.py`ï¼‰
2. Token åŠ å¯†å„²å­˜ï¼ˆFernetï¼‰
3. è‡ªå‹•æ›´æ–°éæœŸ token
4. Device ID ç®¡ç†
5. æ•´åˆæ¸¬è©¦

**é ä¼°æ™‚é–“**ï¼š1 é€±

---

## æ¶æ§‹åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Phase 1: Server ç«¯                    â”‚
â”‚                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  /api/auth/login                                       â”‚  â”‚
â”‚  â”‚  â”œâ”€ é©—è­‰ä½¿ç”¨è€…åç¨±/å¯†ç¢¼                                â”‚  â”‚
â”‚  â”‚  â”œâ”€ ç”Ÿæˆ Access Token (15 åˆ†é˜)                       â”‚  â”‚
â”‚  â”‚  â”œâ”€ ç”Ÿæˆ Refresh Token (7 å¤©, è¨­å‚™ç¶å®š)              â”‚  â”‚
â”‚  â”‚  â””â”€ è¿”å› tokens + user data                           â”‚  â”‚
â”‚  â”‚                                                         â”‚  â”‚
â”‚  â”‚  /api/auth/refresh                                      â”‚  â”‚
â”‚  â”‚  â”œâ”€ é©—è­‰ Refresh Token                                 â”‚  â”‚
â”‚  â”‚  â”œâ”€ æª¢æŸ¥ä½¿ç”¨è€…ä»å­˜åœ¨                                   â”‚  â”‚
â”‚  â”‚  â”œâ”€ ç”Ÿæˆæ–° Access Tokenï¼ˆä½¿ç”¨æœ€æ–°è§’è‰²ï¼‰              â”‚  â”‚
â”‚  â”‚  â””â”€ è¿”å›æ–° access token                               â”‚  â”‚
â”‚  â”‚                                                         â”‚  â”‚
â”‚  â”‚  /api/auth/verify                                       â”‚  â”‚
â”‚  â”‚  â”œâ”€ é©—è­‰ Access Token                                  â”‚  â”‚
â”‚  â”‚  â”œâ”€ æª¢æŸ¥éæœŸæ™‚é–“                                       â”‚  â”‚
â”‚  â”‚  â””â”€ è¿”å›ä½¿ç”¨è€…è³‡è¨Š                                     â”‚  â”‚
â”‚  â”‚                                                         â”‚  â”‚
â”‚  â”‚  /api/auth/revoke                                       â”‚  â”‚
â”‚  â”‚  â””â”€ è¨˜éŒ„ç™»å‡ºäº‹ä»¶                                       â”‚  â”‚
â”‚  â”‚                                                         â”‚  â”‚
â”‚  â”‚  /api/auth/me                                           â”‚  â”‚
â”‚  â”‚  â””â”€ è¿”å›ç•¶å‰ä½¿ç”¨è€…å®Œæ•´è³‡è¨Š                             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                â”‚
â”‚  å¯©è¨ˆæ—¥èªŒï¼š                                                    â”‚
â”‚  âœ… api_login_success / login_failure                          â”‚
â”‚  âœ… token_refresh_success / failure                            â”‚
â”‚  âœ… api_logout                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                              â†“ ä¸‹ä¸€éšæ®µ

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Phase 2: Edge ç«¯ï¼ˆè¨ˆç•«ä¸­ï¼‰                â”‚
â”‚                                                                â”‚
â”‚  EdgeAuthCache                                                 â”‚
â”‚  â”œâ”€ save_tokens(access, refresh, user)                        â”‚
â”‚  â”œâ”€ load_tokens() â†’ dict                                      â”‚
â”‚  â”œâ”€ get_valid_access_token() â†’ str                            â”‚
â”‚  â”œâ”€ _refresh_access_token(refresh_token) â†’ str                â”‚
â”‚  â””â”€ clear()                                                    â”‚
â”‚                                                                â”‚
â”‚  åŠ å¯†å„²å­˜ï¼ˆFernetï¼‰ï¼š                                          â”‚
â”‚  ~/.robot_service/auth_cache.encrypted                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å®‰å…¨è€ƒé‡

### âœ… å·²å¯¦ä½œ

1. **å¯†ç¢¼å®‰å…¨**ï¼š
   - ä½¿ç”¨ Werkzeug çš„ `generate_password_hash` / `check_password_hash`
   - æ°¸ä¸åœ¨ API å›æ‡‰ä¸­è¿”å›å¯†ç¢¼

2. **Token å®‰å…¨**ï¼š
   - JWT ç°½åé˜²æ­¢ç¯¡æ”¹
   - çŸ­æœŸ Access Tokenï¼ˆ15 åˆ†é˜ï¼‰
   - Device ID ç¶å®š Refresh Token

3. **å¯©è¨ˆè¿½è¹¤**ï¼š
   - æ‰€æœ‰èªè­‰äº‹ä»¶è¨˜éŒ„è‡³å¯©è¨ˆæ—¥èªŒ
   - åŒ…å« IPã€User-Agentã€Device ID

4. **é›¶ä¿¡ä»»å‰ç«¯**ï¼š
   - æ‰€æœ‰é©—è­‰åœ¨ Server åŸ·è¡Œ
   - å‰ç«¯åƒ…æŒæœ‰ tokenï¼Œç„¡èªè­‰é‚è¼¯

### âš ï¸ å¾…å¼·åŒ–ï¼ˆPhase 5ï¼‰

1. **Token æ’¤éŠ·**ï¼š
   - ç›®å‰ JWT ç„¡ç‹€æ…‹ï¼Œç„¡æ³•çœŸæ­£æ’¤éŠ·
   - éœ€è¦ï¼šRedis é»‘åå–®æˆ– token ç‰ˆæœ¬æ©Ÿåˆ¶

2. **é€Ÿç‡é™åˆ¶**ï¼š
   - é˜²æ­¢æš´åŠ›ç ´è§£
   - éœ€è¦ï¼šFlask-Limiter

3. **HTTPS å¼·åˆ¶**ï¼š
   - ç”Ÿç”¢ç’°å¢ƒå¿…é ˆä½¿ç”¨ HTTPS
   - é˜²æ­¢ token åœ¨å‚³è¼¸ä¸­è¢«ç«Šå–

4. **è¨­å‚™ç®¡ç†**ï¼š
   - ä½¿ç”¨è€…æ‡‰èƒ½æŸ¥çœ‹/æ’¤éŠ·å·²æˆæ¬Šè¨­å‚™
   - éœ€è¦ï¼šDevice æ¨¡å‹èˆ‡ç®¡ç†ä»‹é¢

## åƒè€ƒæ–‡ä»¶

- [edge-cloud-auth-analysis.md](edge-cloud-auth-analysis.md) - æ–¹æ¡ˆåˆ†æèˆ‡æ¯”è¼ƒ
- [threat-model.md](threat-model.md) - å¨è„…æ¨¡å‹ v2.0
- [security-checklist.md](security-checklist.md) - å®‰å…¨æª¢æŸ¥æ¸…å–®
- [audit-logging-implementation.md](audit-logging-implementation.md) - å¯©è¨ˆæ—¥èªŒå¯¦ä½œ

---

**æœ€å¾Œæ›´æ–°**ï¼š2025-12-17  
**ç‹€æ…‹**ï¼šPhase 1 å®Œæˆï¼ŒPhase 2 è¦åŠƒä¸­
