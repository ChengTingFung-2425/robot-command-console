#!/usr/bin/env python3
"""
Flask 背景服務 for Electron POC
使用模組化的 robot_service
Port: 5000
Auth: Bearer token from APP_TOKEN environment variable
"""

import asyncio
import logging
import os
import sys

# 添加 src 到路徑
sys.path.insert(0, os.path.join(os.path.dirname(__file__), 'src'))

from robot_service.electron import create_flask_app
from robot_service.service_manager import ServiceManager


logger = logging.getLogger(__name__)


def main():
    """主函式"""
    PORT = int(os.environ.get('PORT', 5000))
    APP_TOKEN = os.environ.get('APP_TOKEN')
    
    if not APP_TOKEN:
        print('ERROR: APP_TOKEN environment variable not set', file=sys.stderr)
        sys.exit(1)
    
    # 建立服務管理器
    service_manager = ServiceManager(
        queue_max_size=1000,
        max_workers=5,
        poll_interval=0.1,
    )
    
    # 啟動服務管理器（在背景執行）
    loop = asyncio.new_event_loop()
    asyncio.set_event_loop(loop)
    loop.run_until_complete(service_manager.start())
    
    # 建立 Flask 應用
    app = create_flask_app(
        service_manager=service_manager,
        app_token=APP_TOKEN,
    )
    
    logger.info('Starting Flask service', extra={
        'host': '127.0.0.1',
        'port': PORT,
        'service': 'flask-service'
    })
    
    try:
        # 只監聽 localhost 確保安全
        app.run(host='127.0.0.1', port=PORT, debug=False)
    finally:
        # 清理
        loop.run_until_complete(service_manager.stop())
        loop.close()


if __name__ == '__main__':
    main()
