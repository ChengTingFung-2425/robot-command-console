{% extends "edge/base.html" %}

{% block title %}æŒ‡ä»¤æ§åˆ¶ä¸­å¿ƒ{% endblock %}

{% block content %}
<div class="page-header">
    <h1>ğŸ® æŒ‡ä»¤æ§åˆ¶ä¸­å¿ƒ</h1>
    <p class="subtitle">é¸æ“‡æ©Ÿå™¨äººä¸¦ç™¼é€å‹•ä½œæŒ‡ä»¤</p>
</div>

<div class="control-layout">
    <!-- å·¦å´ï¼šæ©Ÿå™¨äººé¸æ“‡ -->
    <div class="control-sidebar">
        <h3>é¸æ“‡æ©Ÿå™¨äºº</h3>
        <div id="robot-selector" class="robot-selector">
            {% if robots %}
                {% for robot in robots %}
                <div class="robot-option" data-robot-id="{{ robot.id }}" onclick="selectRobot('{{ robot.id }}')">
                    <span class="robot-icon">ğŸ¤–</span>
                    <span class="robot-name">{{ robot.name }}</span>
                    <span class="robot-status status-{{ robot.status }}">{{ robot.status }}</span>
                </div>
                {% endfor %}
            {% else %}
                <div class="empty-state">
                    <p>å°šç„¡æ©Ÿå™¨äºº</p>
                    <a href="{{ url_for('edge_ui.ui_dashboard') }}" class="btn btn-sm btn-primary">
                        â• è¨»å†Šæ©Ÿå™¨äºº
                    </a>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- å³å´ï¼šæŒ‡ä»¤å€åŸŸ -->
    <div class="control-main">
        <div id="no-robot-selected" class="placeholder">
            <div class="placeholder-icon">ğŸ‘ˆ</div>
            <h3>è«‹å…ˆé¸æ“‡æ©Ÿå™¨äºº</h3>
            <p>å¾å·¦å´åˆ—è¡¨é¸æ“‡è¦æ§åˆ¶çš„æ©Ÿå™¨äºº</p>
        </div>

        <div id="command-panel" class="command-panel" style="display: none;">
            <div class="selected-robot-info">
                <h3>
                    <span class="robot-icon">ğŸ¤–</span>
                    <span id="selected-robot-name">-</span>
                </h3>
                <span id="selected-robot-status" class="robot-status">-</span>
            </div>

            <!-- å¿«æ·å‹•ä½œæŒ‰éˆ• -->
            <div class="action-section">
                <h4>ğŸƒ ç§»å‹•æ§åˆ¶</h4>
                <div class="action-grid">
                    <button class="action-btn" onclick="sendAction('go_forward')">â¬†ï¸ å‰é€²</button>
                    <button class="action-btn" onclick="sendAction('back_fast')">â¬‡ï¸ å¾Œé€€</button>
                    <button class="action-btn" onclick="sendAction('turn_left')">â¬…ï¸ å·¦è½‰</button>
                    <button class="action-btn" onclick="sendAction('turn_right')">â¡ï¸ å³è½‰</button>
                    <button class="action-btn" onclick="sendAction('left_move_fast')">â†™ï¸ å·¦ç§»</button>
                    <button class="action-btn" onclick="sendAction('right_move_fast')">â†˜ï¸ å³ç§»</button>
                </div>
            </div>

            <div class="action-section">
                <h4>ğŸ§ å§¿æ…‹æ§åˆ¶</h4>
                <div class="action-grid">
                    <button class="action-btn" onclick="sendAction('stand')">ğŸ§ ç«™ç«‹</button>
                    <button class="action-btn" onclick="sendAction('bow')">ğŸ™‡ é èº¬</button>
                    <button class="action-btn" onclick="sendAction('squat')">ğŸ‹ï¸ è¹²ä¸‹</button>
                    <button class="action-btn" onclick="sendAction('wave')">ğŸ‘‹ æ®æ‰‹</button>
                    <button class="action-btn" onclick="sendAction('stand_up_front')">â†—ï¸ å‰èµ·èº«</button>
                    <button class="action-btn" onclick="sendAction('stand_up_back')">â†˜ï¸ å¾Œèµ·èº«</button>
                </div>
            </div>

            <div class="action-section">
                <h4>ğŸ’ƒ èˆè¹ˆå‹•ä½œ</h4>
                <div class="action-grid">
                    <button class="action-btn" onclick="sendAction('dance_two')">ğŸ’ƒ èˆè¹ˆ 2</button>
                    <button class="action-btn" onclick="sendAction('dance_three')">ğŸ’ƒ èˆè¹ˆ 3</button>
                    <button class="action-btn" onclick="sendAction('dance_four')">ğŸ’ƒ èˆè¹ˆ 4</button>
                    <button class="action-btn" onclick="sendAction('dance_five')">ğŸ’ƒ èˆè¹ˆ 5</button>
                </div>
            </div>

            <div class="action-section">
                <h4>âš ï¸ ç·Šæ€¥æ§åˆ¶</h4>
                <div class="action-grid">
                    <button class="action-btn action-danger" onclick="sendAction('stop')">ğŸ›‘ åœæ­¢</button>
                </div>
            </div>

            <!-- åŸ·è¡Œæ­·å² -->
            <div class="history-section">
                <h4>ğŸ“‹ åŸ·è¡Œæ­·å²</h4>
                <div id="command-history" class="command-history">
                    <p class="placeholder-text">å°šç„¡åŸ·è¡Œè¨˜éŒ„</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let selectedRobotId = null;
let commandHistory = [];

// å¾ URL åƒæ•¸é¸æ“‡æ©Ÿå™¨äºº
document.addEventListener('DOMContentLoaded', function() {
    const params = new URLSearchParams(window.location.search);
    const robotId = params.get('robot');
    if (robotId) {
        selectRobot(robotId);
    }
});

// é¸æ“‡æ©Ÿå™¨äºº
async function selectRobot(robotId) {
    selectedRobotId = robotId;
    
    // æ›´æ–°é¸ä¸­ç‹€æ…‹
    document.querySelectorAll('.robot-option').forEach(el => {
        el.classList.remove('selected');
    });
    const selectedOption = document.querySelector(`[data-robot-id="${robotId}"]`);
    if (selectedOption) {
        selectedOption.classList.add('selected');
    }
    
    // ç²å–æ©Ÿå™¨äººè³‡æ–™
    try {
        const res = await fetch(`/api/edge/robots/${robotId}`);
        const data = await res.json();
        
        if (data.robot) {
            document.getElementById('selected-robot-name').textContent = data.robot.name;
            document.getElementById('selected-robot-status').textContent = data.robot.status;
            document.getElementById('selected-robot-status').className = `robot-status status-${data.robot.status}`;
            
            document.getElementById('no-robot-selected').style.display = 'none';
            document.getElementById('command-panel').style.display = 'block';
        }
    } catch (error) {
        console.error('Failed to load robot:', error);
    }
}

// ç™¼é€å‹•ä½œæŒ‡ä»¤
async function sendAction(action) {
    if (!selectedRobotId) {
        showToast('è«‹å…ˆé¸æ“‡æ©Ÿå™¨äºº', 'warning');
        return;
    }
    
    // æ·»åŠ åˆ°æ­·å²
    addToHistory(action, 'pending');
    
    try {
        // é€™è£¡æœƒèª¿ç”¨å¯¦éš›çš„æŒ‡ä»¤ API
        const res = await fetch('/api/command', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                // Token æœƒç”± Electron æ³¨å…¥
            },
            body: JSON.stringify({
                robot_id: selectedRobotId,
                command: action,
                priority: 'NORMAL'
            })
        });
        
        const data = await res.json();
        
        if (res.ok) {
            updateHistoryStatus(action, 'success', data.message_id);
        } else {
            updateHistoryStatus(action, 'error', data.error);
        }
    } catch (error) {
        console.error('Failed to send action:', error);
        updateHistoryStatus(action, 'error', error.message);
    }
}

// æ·»åŠ åˆ°æ­·å²è¨˜éŒ„
function addToHistory(action, status) {
    const timestamp = new Date().toLocaleTimeString();
    commandHistory.unshift({
        action,
        status,
        timestamp,
        id: Date.now()
    });
    
    // ä¿æŒæœ€å¤š 20 æ¢è¨˜éŒ„
    if (commandHistory.length > 20) {
        commandHistory.pop();
    }
    
    renderHistory();
}

// æ›´æ–°æ­·å²è¨˜éŒ„ç‹€æ…‹
function updateHistoryStatus(action, status, message) {
    const item = commandHistory.find(h => h.action === action && h.status === 'pending');
    if (item) {
        item.status = status;
        item.message = message;
        renderHistory();
    }
}

// æ¸²æŸ“æ­·å²è¨˜éŒ„
function renderHistory() {
    const container = document.getElementById('command-history');
    
    if (commandHistory.length === 0) {
        container.innerHTML = '<p class="placeholder-text">å°šç„¡åŸ·è¡Œè¨˜éŒ„</p>';
        return;
    }
    
    container.innerHTML = commandHistory.map(item => `
        <div class="history-item status-${item.status}">
            <span class="history-time">${item.timestamp}</span>
            <span class="history-action">${item.action}</span>
            <span class="history-status">${getStatusIcon(item.status)}</span>
        </div>
    `).join('');
}

// ç‹€æ…‹åœ–ç¤º
function getStatusIcon(status) {
    switch (status) {
        case 'pending': return 'â³';
        case 'success': return 'âœ…';
        case 'error': return 'âŒ';
        default: return 'â“';
    }
}

// é¡¯ç¤ºæç¤ºè¨Šæ¯
function showToast(message, type = 'success', duration = 3000) {
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, duration);
}
</script>
{% endblock %}
