{% extends "edge/base.html" %}

{% block title %}æ©Ÿå™¨äººå„€è¡¨æ¿{% endblock %}

{% block content %}
<div class="page-header">
    <h1>ğŸ“Š æ©Ÿå™¨äººå„€è¡¨æ¿</h1>
    <p class="subtitle">ç›£æ§æ‰€æœ‰æœ¬åœ°æ©Ÿå™¨äººç‹€æ…‹</p>
</div>

<div class="toolbar">
    <button class="btn btn-primary" onclick="showRegisterModal()">
        â• è¨»å†Šæ©Ÿå™¨äºº
    </button>
    <button class="btn btn-secondary" onclick="refreshRobots()">
        ğŸ”„ é‡æ–°æ•´ç†
    </button>
</div>

<div class="robots-grid" id="robots-container">
    {% if robots %}
        {% for robot in robots %}
        <div class="robot-card" data-robot-id="{{ robot.id }}">
            <div class="robot-header">
                <span class="robot-icon">ğŸ¤–</span>
                <h3 class="robot-name">{{ robot.name }}</h3>
                <span class="robot-status status-{{ robot.status }}">
                    {{ robot.status }}
                </span>
            </div>
            <div class="robot-body">
                <div class="robot-info">
                    <div class="info-row">
                        <span class="info-label">é¡å‹</span>
                        <span class="info-value">{{ robot.type }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">é›»é‡</span>
                        <div class="battery-bar">
                            <div class="battery-level" style="width: {{ robot.battery }}%"></div>
                        </div>
                        <span class="info-value">{{ robot.battery }}%</span>
                    </div>
                    {% if robot.location %}
                    <div class="info-row">
                        <span class="info-label">ä½ç½®</span>
                        <span class="info-value">{{ robot.location }}</span>
                    </div>
                    {% endif %}
                    <div class="info-row">
                        <span class="info-label">é€£ç·š</span>
                        <span class="info-value">
                            {% if robot.connected %}
                            <span class="status-indicator status-success">ğŸŸ¢ å·²é€£ç·š</span>
                            {% else %}
                            <span class="status-indicator status-error">ğŸ”´ æœªé€£ç·š</span>
                            {% endif %}
                        </span>
                    </div>
                </div>
            </div>
            <div class="robot-actions">
                <button class="btn btn-sm btn-primary" onclick="selectRobot('{{ robot.id }}')">
                    ğŸ® æ§åˆ¶
                </button>
                <button class="btn btn-sm btn-info" onclick="viewDetails('{{ robot.id }}')">
                    ğŸ“‹ è©³æƒ…
                </button>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="empty-state">
            <div class="empty-icon">ğŸ¤–</div>
            <h3>å°šç„¡æ©Ÿå™¨äºº</h3>
            <p>é»æ“Šã€Œè¨»å†Šæ©Ÿå™¨äººã€æŒ‰éˆ•æ–°å¢æ‚¨çš„ç¬¬ä¸€å€‹æ©Ÿå™¨äºº</p>
            <button class="btn btn-primary" onclick="showRegisterModal()">
                â• è¨»å†Šæ©Ÿå™¨äºº
            </button>
        </div>
    {% endif %}
</div>

<!-- è¨»å†Šæ©Ÿå™¨äººå°è©±æ¡† -->
<div id="register-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2>â• è¨»å†Šæ©Ÿå™¨äºº</h2>
            <button class="modal-close" onclick="hideRegisterModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="register-form">
                <div class="form-group">
                    <label for="robot-name">æ©Ÿå™¨äººåç¨±</label>
                    <input type="text" id="robot-name" name="name" required placeholder="ä¾‹ï¼šæˆ‘çš„æ©Ÿå™¨äºº">
                </div>
                <div class="form-group">
                    <label for="robot-type">é¡å‹</label>
                    <select id="robot-type" name="type">
                        <option value="humanoid">äººå½¢æ©Ÿå™¨äºº</option>
                        <option value="agv">AGV æ¬é‹è»Š</option>
                        <option value="arm">æ©Ÿæ¢°æ‰‹è‡‚</option>
                        <option value="drone">ç„¡äººæ©Ÿ</option>
                        <option value="other">å…¶ä»–</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="robot-location">ä½ç½®ï¼ˆå¯é¸ï¼‰</label>
                    <input type="text" id="robot-location" name="location" placeholder="ä¾‹ï¼šå¯¦é©—å®¤ A">
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="hideRegisterModal()">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="submitRegister()">è¨»å†Š</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// é‡æ–°æ•´ç†æ©Ÿå™¨äººåˆ—è¡¨
async function refreshRobots() {
    try {
        const res = await fetch('/api/edge/robots');
        const data = await res.json();
        
        // ç„¡è«–åˆ—è¡¨æ˜¯å¦ç‚ºç©ºéƒ½è¦æ¸²æŸ“ï¼Œä»¥æ­£ç¢ºé¡¯ç¤ºç©ºç™½ç‹€æ…‹
        renderRobots(data.robots || []);
    } catch (error) {
        console.error('Failed to refresh robots:', error);
    }
}

// æ¸²æŸ“æ©Ÿå™¨äººåˆ—è¡¨
function renderRobots(robots) {
    const container = document.getElementById('robots-container');
    
    if (robots.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">ğŸ¤–</div>
                <h3>å°šç„¡æ©Ÿå™¨äºº</h3>
                <p>é»æ“Šã€Œè¨»å†Šæ©Ÿå™¨äººã€æŒ‰éˆ•æ–°å¢æ‚¨çš„ç¬¬ä¸€å€‹æ©Ÿå™¨äºº</p>
                <button class="btn btn-primary" onclick="showRegisterModal()">
                    â• è¨»å†Šæ©Ÿå™¨äºº
                </button>
            </div>
        `;
        return;
    }
    
    container.innerHTML = robots.map(robot => `
        <div class="robot-card" data-robot-id="${robot.id}">
            <div class="robot-header">
                <span class="robot-icon">ğŸ¤–</span>
                <h3 class="robot-name">${robot.name}</h3>
                <span class="robot-status status-${robot.status}">
                    ${robot.status}
                </span>
            </div>
            <div class="robot-body">
                <div class="robot-info">
                    <div class="info-row">
                        <span class="info-label">é¡å‹</span>
                        <span class="info-value">${robot.type}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">é›»é‡</span>
                        <div class="battery-bar">
                            <div class="battery-level" style="width: ${robot.battery}%"></div>
                        </div>
                        <span class="info-value">${robot.battery}%</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">é€£ç·š</span>
                        <span class="info-value">
                            ${robot.connected 
                                ? '<span class="status-indicator status-success">ğŸŸ¢ å·²é€£ç·š</span>'
                                : '<span class="status-indicator status-error">ğŸ”´ æœªé€£ç·š</span>'}
                        </span>
                    </div>
                </div>
            </div>
            <div class="robot-actions">
                <button class="btn btn-sm btn-primary" onclick="selectRobot('${robot.id}')">
                    ğŸ® æ§åˆ¶
                </button>
                <button class="btn btn-sm btn-info" onclick="viewDetails('${robot.id}')">
                    ğŸ“‹ è©³æƒ…
                </button>
            </div>
        </div>
    `).join('');
}

// é¡¯ç¤ºè¨»å†Šå°è©±æ¡†
function showRegisterModal() {
    document.getElementById('register-modal').style.display = 'flex';
}

// éš±è—è¨»å†Šå°è©±æ¡†
function hideRegisterModal() {
    document.getElementById('register-modal').style.display = 'none';
    document.getElementById('register-form').reset();
}

// æäº¤è¨»å†Š
async function submitRegister() {
    const form = document.getElementById('register-form');
    const formData = new FormData(form);
    
    const robotData = {
        name: formData.get('name'),
        type: formData.get('type'),
        location: formData.get('location') || null,
    };
    
    try {
        const res = await fetch('/api/edge/robots', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(robotData)
        });
        
        const data = await res.json();
        if (data.success) {
            hideRegisterModal();
            refreshRobots();
            showToast('æ©Ÿå™¨äººè¨»å†ŠæˆåŠŸ');
        } else {
            showToast('è¨»å†Šå¤±æ•—: ' + (data.error || 'æœªçŸ¥éŒ¯èª¤'), 'error');
        }
    } catch (error) {
        console.error('Failed to register robot:', error);
        showToast('è¨»å†Šå¤±æ•—', 'error');
    }
}

// é¸æ“‡æ©Ÿå™¨äººï¼ˆå°å‘æ§åˆ¶ä¸­å¿ƒï¼‰
function selectRobot(robotId) {
    window.location.href = `/ui/command-center?robot=${robotId}`;
}

// æŸ¥çœ‹è©³æƒ…
function viewDetails(robotId) {
    showToast('æ©Ÿå™¨äººè©³æƒ…åŠŸèƒ½é–‹ç™¼ä¸­...', 'info');
}

// é¡¯ç¤ºæç¤ºè¨Šæ¯
function showToast(message, type = 'success', duration = 3000) {
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, duration);
}

// é é¢è¼‰å…¥æ™‚åˆ·æ–°
document.addEventListener('DOMContentLoaded', refreshRobots);
</script>
{% endblock %}
