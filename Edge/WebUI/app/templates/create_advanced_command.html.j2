{% extends "base.html.j2" %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/blockly_workspace.css') }}">
{% endblock %}

{% block scripts %}
{{ super() }}
<!-- Blockly æ ¸å¿ƒåº« -->
<script src="https://unpkg.com/blockly/blockly.min.js"></script>
<!-- è‡ªå®šç¾©æ©Ÿå™¨äººç©æœ¨ -->
<script src="{{ url_for('static', filename='js/robot_blocks.js') }}"></script>

<script>
// Blockly å·¥ä½œå€å¯¦ä¾‹
var workspace;
var isDirty = false;
// ä¼ºæœå™¨å¯æ³¨å…¥çš„å·²é©—è­‰é€²éšæŒ‡ä»¤æ¸…å–®ï¼ˆä¾‹ï¼š['patrol_A', 'dance_show']ï¼‰
var VERIFIED_ADVANCED_COMMANDS = window.VERIFIED_ADVANCED_COMMANDS || {{ verified_advanced_commands|tojson|safe }} || [];
// Server-provided duration unit preference (s or ms)
window.DURATION_UNIT = window.DURATION_UNIT || '{{ duration_unit }}';

// åˆå§‹åŒ– Blockly
document.addEventListener('DOMContentLoaded', function() {
  workspace = Blockly.inject('blocklyDiv', {
    toolbox: ROBOT_TOOLBOX,
    grid: {
      spacing: 20,
      length: 3,
      colour: '#ccc',
      snap: true
    },
    zoom: {
      controls: true,
      wheel: true,
      startScale: 1.0,
      maxScale: 3,
      minScale: 0.3,
      scaleSpeed: 1.2
    },
    trashcan: true,
    scrollbars: true,
    sounds: true,
    renderer: 'zelos'
  });

  // ç›£è½å·¥ä½œå€è®Šæ›´
  workspace.addChangeListener(function(event) {
    if (event.type === Blockly.Events.BLOCK_CHANGE ||
        event.type === Blockly.Events.BLOCK_CREATE ||
        event.type === Blockly.Events.BLOCK_DELETE ||
        event.type === Blockly.Events.BLOCK_MOVE) {
      updateCodePreview();
      isDirty = true;
    }
  });

  // è¼‰å…¥ç¾æœ‰ç©æœ¨ï¼ˆå¦‚æœæœ‰ï¼‰
  var savedBlocks = document.getElementById('saved_blocks').value;
  if (savedBlocks) {
    try {
      var xml = Blockly.Xml.textToDom(savedBlocks);
      Blockly.Xml.domToWorkspace(xml, workspace);
    } catch (e) {
      console.error('è¼‰å…¥ç©æœ¨å¤±æ•—:', e);
    }
  }
  
  // ç§»é™¤ä»»ä½•èˆŠç‰ˆçš„ JSON é è¦½å…ƒç´ ï¼ˆè‹¥æœ‰æ®˜ç•™ï¼‰
  var oldJsonPreview = document.getElementById('json-preview');
  if (oldJsonPreview) {
    oldJsonPreview.remove();
  }
  updateCodePreview();

  // æ¢å¾© verify é¢æ¿çš„æ‘ºç–Šç‹€æ…‹ ï¼ˆserver-side å„ªå…ˆï¼Œclient localStorage ç‚ºæ¬¡ï¼‰
  try {
    var serverVerifyCollapsed = {{ 'true' if verify_collapsed else 'false' }};
    var localVerify = (localStorage.getItem && localStorage.getItem('verifyCollapsed') === '1');
    var verifyCollapsed = serverVerifyCollapsed || localVerify;
    if (verifyCollapsed) {
      document.getElementById('verifyCol').classList.add('collapsed');
      var btn = document.getElementById('verify-toggle');
      if (btn) btn.textContent = 'â–¸';
      if (workspace && typeof workspace.resize === 'function') {
        setTimeout(function(){ workspace.resize(); }, 50);
      }
    }
  } catch (e) {}
});

// åˆ‡æ›é©—è­‰é¢æ¿æ‘ºç–Š
function toggleVerifyPanel() {
  var col = document.getElementById('verifyCol');
  var btn = document.getElementById('verify-toggle');
  if (!col) return;
  var collapsed = col.classList.toggle('collapsed');
  if (btn) btn.textContent = collapsed ? 'â–¸' : 'â–¾';
  try { localStorage.setItem('verifyCollapsed', collapsed ? '1' : '0'); } catch (e) {}
  try { fetch('{{ url_for("webui.update_ui_settings") }}', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({verify_collapsed: collapsed ? '1' : '0'})}); } catch (e) {}
  // è®“ Blockly é‡æ–°èª¿æ•´å¤§å°ï¼ˆé‡è¦ï¼‰
  if (workspace && typeof workspace.resize === 'function') {
    setTimeout(function(){ workspace.resize(); }, 200);
  }
}

// æ›´æ–°ç¨‹å¼ç¢¼é è¦½
function updateCodePreview() {
  var json = generateCommandJSON(workspace);
  document.getElementById('base_commands').value = json;
  // å³å´æ”¹ç‚ºé©—è­‰é¢æ¿ï¼Œä¸ç›´æ¥é¡¯ç¤º JSON
  // è¨ˆç®—é ä¼°åŸ·è¡Œæ™‚é–“
  updateEstimatedTime(json);
}

// è¨ˆç®—é ä¼°åŸ·è¡Œæ™‚é–“
function updateEstimatedTime(jsonString) {
  try {
    var commands = JSON.parse(jsonString);
    var totalTime = 0;
    
    // å¾ Robot-Console/tools.py æå–çš„æ™‚é–“å°æ‡‰è¡¨
    var actionTimes = {
      "go_forward": 3.5, "back_fast": 4.5, "turn_left": 4, "turn_right": 4,
      "left_move_fast": 3, "right_move_fast": 3, "stand": 1, "bow": 4,
      "squat": 1, "stand_up_front": 5, "stand_up_back": 5, "wave": 3.5,
      "left_kick": 2, "right_kick": 2, "kung_fu": 2, "wing_chun": 2,
      "left_uppercut": 2, "right_uppercut": 2, "left_shot_fast": 4, "right_shot_fast": 4,
      "dance_two": 52, "dance_three": 70, "dance_four": 59, "dance_five": 59,
      "dance_six": 69, "dance_seven": 67, "dance_eight": 85, "dance_nine": 84, "dance_ten": 85,
      "push_ups": 9, "sit_ups": 12, "chest": 9, "weightlifting": 9,
      "squat_up": 6, "twist": 4, "stepping": 3, "stop": 3
    };
    
    commands.forEach(function(cmd) {
      if (cmd.command === 'wait' && cmd.duration_ms) {
        totalTime += cmd.duration_ms / 1000;
      } else if (actionTimes[cmd.command]) {
        totalTime += actionTimes[cmd.command];
      }
    });
    
    var minutes = Math.floor(totalTime / 60);
    var seconds = Math.floor(totalTime % 60);
    var timeText = minutes > 0 
      ? `ç´„ ${minutes} åˆ† ${seconds} ç§’` 
      : `ç´„ ${seconds} ç§’`;
    
    document.getElementById('estimated-time').textContent = timeText;
    document.getElementById('block-count').textContent = commands.length;
  } catch (e) {
    document.getElementById('estimated-time').textContent = 'è¨ˆç®—ä¸­...';
    document.getElementById('block-count').textContent = '0';
  }
}

// å„²å­˜ç©æœ¨ç‹€æ…‹
function saveBlocklyState() {
  var xml = Blockly.Xml.workspaceToDom(workspace);
  var xmlText = Blockly.Xml.domToText(xml);
  document.getElementById('saved_blocks').value = xmlText;
}

// æ¸…ç©ºå·¥ä½œå€
function clearWorkspace() {
  if (confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰ç©æœ¨å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
    workspace.clear();
    isDirty = false;
  }
}

// åŒ¯å‡ºç©æœ¨
function exportBlocks() {
  var xml = Blockly.Xml.workspaceToDom(workspace);
  var xmlText = Blockly.Xml.domToText(xml);
  
  var blob = new Blob([xmlText], {type: 'text/xml'});
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'robot_command_blocks.xml';
  a.click();
  URL.revokeObjectURL(url);
}

// åŒ¯å…¥ç©æœ¨
function importBlocks() {
  var input = document.createElement('input');
  input.type = 'file';
  input.accept = '.xml';
  input.onchange = function(e) {
    var file = e.target.files[0];
    var reader = new FileReader();
    reader.onload = function(event) {
      try {
        var xml = Blockly.Xml.textToDom(event.target.result);
        workspace.clear();
        Blockly.Xml.domToWorkspace(xml, workspace);
        isDirty = true;
        // åŒ¯å…¥å®Œæˆ
      } catch (err) {
        alert('åŒ¯å…¥å¤±æ•—ï¼šç„¡æ•ˆçš„ç©æœ¨æª”æ¡ˆ');
        console.error(err);
      }
    };
    reader.readAsText(file);
  };
  input.click();
}

// é©—è­‰æŒ‡ä»¤çš„ç°¡å–®å‰ç«¯æª¢æŸ¥ï¼ˆæœƒé¡¯ç¤ºæª¢æŸ¥çµæœåœ¨å³å´é¢æ¿ï¼‰
function validateCommands() {
  var json = generateCommandJSON(workspace);
  var resultEl = document.getElementById('verify-result');
  try {
    var parsed = JSON.parse(json);
    if (!Array.isArray(parsed) || parsed.length === 0) {
      resultEl.textContent = 'é©—è­‰çµæœï¼šå¤±æ•— - å·¥ä½œå€æ²’æœ‰ä»»ä½•å‹•ä½œï¼Œè‡³å°‘éœ€è¦ä¸€å€‹å‹•ä½œã€‚';
      return;
    }
    // é©—è­‰æ¯å€‹æŒ‡ä»¤çš„åŸºæœ¬æ¬„ä½ï¼Œä¸¦ç‰¹åˆ¥è™•ç† advanced æŒ‡ä»¤
    var invalids = [];
    parsed.forEach(function(cmd, idx) {
      if (!cmd.command) {
        invalids.push('ç¬¬ ' + (idx+1) + ' å€‹æŒ‡ä»¤ç¼ºå°‘ command æ¬„ä½');
        return;
      }

      // advanced æŒ‡ä»¤éœ€åŒ…å« name èˆ‡ verified ä¸¦ä¸”åœ¨ä¼ºæœå™¨ç™½åå–®ä¸­
      if (cmd.advanced) {
        var name = cmd.name || '';
        var verifiedFlag = !!cmd.verified;
        if (!name) {
          invalids.push('ç¬¬ ' + (idx+1) + ' å€‹é€²éšæŒ‡ä»¤æœªæŒ‡å®šåç¨±');
          return;
        }
        if (!verifiedFlag) {
          invalids.push('ç¬¬ ' + (idx+1) + ' å€‹é€²éšæŒ‡ä»¤ (' + name + ') æœªæ¨™è¨˜ç‚ºå·²é©—è­‰');
          return;
        }
        // è‹¥å¾Œç«¯æä¾› VERIFIED_ADVANCED_COMMANDSï¼Œéœ€åœ¨ç™½åå–®ä¸­
        if (VERIFIED_ADVANCED_COMMANDS && VERIFIED_ADVANCED_COMMANDS.length > 0) {
          if (VERIFIED_ADVANCED_COMMANDS.indexOf(name) === -1) {
            invalids.push('ç¬¬ ' + (idx+1) + ' å€‹é€²éšæŒ‡ä»¤ (' + name + ') æœªåœ¨å·²é©—è­‰æ¸…å–®ä¸­');
            return;
          }
        }
      }
    });
    if (invalids.length > 0) {
      resultEl.textContent = 'é©—è­‰çµæœï¼šå¤±æ•—\n' + invalids.join('\n');
      return;
    } else {
      // é€²ä¸€æ­¥å‰ç«¯é©—è­‰ duration æ¬„ä½
      var durationErrors = frontendVerifyDurations(parsed);
      if (durationErrors.length > 0) {
        resultEl.textContent = 'é©—è­‰çµæœï¼šå¤±æ•—\n' + durationErrors.join('\n');
        return;
      }
      resultEl.textContent = 'é©—è­‰çµæœï¼šé€šé \næŒ‡ä»¤æ•¸é‡ï¼š' + parsed.length;
    }
  } catch (e) {
    resultEl.textContent = 'é©—è­‰çµæœï¼šå¤±æ•— - JSON è§£æéŒ¯èª¤';
  }
}

// ç¢ºä¿ starter block æ°¸é å­˜åœ¨ï¼Œè‹¥è¢«ç§»é™¤å‰‡è‡ªå‹•è£œå›
// NOTE: ensureStarterExists removed â€” starter is now available from toolbox and draggable by the user.

// è¡¨å–®æäº¤å‰å„²å­˜ç©æœ¨ç‹€æ…‹
document.addEventListener('DOMContentLoaded', function() {
  var form = document.querySelector('form');
  if (form) {
    form.addEventListener('submit', function(e) {
      saveBlocklyState();
    });
  }
});

// åˆå§‹åŒ–æ™‚é–“å–®ä½åå¥½ï¼ˆç§’ / æ¯«ç§’ï¼‰
document.addEventListener('DOMContentLoaded', function() {
  try {
    var pref = localStorage.getItem('durationUnit') || 's';
    window.DURATION_UNIT = pref;
    if (pref === 'ms') {
      document.getElementById('unit_ms').checked = true;
    } else {
      document.getElementById('unit_s').checked = true;
    }
  } catch (e) {}

  // ç¶å®šåˆ‡æ›äº‹ä»¶
  var unitS = document.getElementById('unit_s');
  var unitMs = document.getElementById('unit_ms');
  function updateDurationUnit(unit) {
    try {
      localStorage.setItem('durationUnit', unit);
      window.DURATION_UNIT = unit;
    } catch (e) {}
    try {
      postDurationUnitSetting(unit);
    } catch (e) {}
  }
  function postDurationUnitSetting(unit) {
    fetch('{{ url_for("webui.update_ui_settings") }}', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ duration_unit: unit })
    });
  }
  if (unitS) unitS.addEventListener('change', function() {
    if (this.checked) {
      updateDurationUnit('s');
    }
  });
  if (unitMs) unitMs.addEventListener('change', function() {
    if (this.checked) {
      updateDurationUnit('ms');
    }
  });
});

// å‰ç«¯é©—è­‰ï¼šæª¢æŸ¥ç§»å‹•é¡ç©æœ¨çš„ duration æ¬„ä½
// è‹¥ä½¿ç”¨ç§’ï¼Œå…è¨± 0.1 ~ 600ï¼›è‹¥æ¯«ç§’ï¼Œå…è¨± 100 ~ 600000
function frontendVerifyDurations(parsedCommands) {
  var errors = [];
  parsedCommands.forEach(function(cmd, idx){
    // åªæª¢æŸ¥å·²çŸ¥çš„ç§»å‹•å‹•ä½œ
    var moveActions = ['go_forward','back_fast','turn_left','turn_right','left_move_fast','right_move_fast'];
    if (moveActions.indexOf(cmd.command) !== -1) {
      if (cmd.duration_s === undefined && cmd.duration_ms === undefined) {
        errors.push('ç¬¬ ' + (idx+1) + ' å€‹å‹•ä½œ ('+cmd.command+') ç¼ºå°‘æŒçºŒæ™‚é–“');
        return;
      }
      var unit = (window.DURATION_UNIT) || (localStorage.getItem && localStorage.getItem('durationUnit')) || 's';
      if (cmd.duration_s !== undefined) {
        var v = parseFloat(cmd.duration_s);
        if (isNaN(v) || v < 0.1 || v > 600) errors.push('ç¬¬ ' + (idx+1) + ' å€‹å‹•ä½œ ('+cmd.command+') çš„æŒçºŒæ™‚é–“éœ€ä»‹æ–¼ 0.1~600 ç§’');
      } else if (cmd.duration_ms !== undefined) {
        var v = parseInt(cmd.duration_ms,10);
        if (isNaN(v) || v < 100 || v > 600000) errors.push('ç¬¬ ' + (idx+1) + ' å€‹å‹•ä½œ ('+cmd.command+') çš„æŒçºŒæ™‚é–“éœ€ä»‹æ–¼ 100~600000 æ¯«ç§’');
      }
    }
  });
  return errors;
}
</script>
{% endblock %}

{% block app_content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <h2>ğŸ§© å»ºç«‹é€²éšæŒ‡ä»¤ï¼ˆç¨‹å¼ç©æœ¨ç·¨è¼¯å™¨ï¼‰</h2>
      <p class="text-muted">ä½¿ç”¨æ‹–æ”¾å¼ç©æœ¨ä¾†çµ„åˆæ©Ÿå™¨äººå‹•ä½œåºåˆ—ï¼Œç„¡éœ€æ‰‹å‹•ç·¨å¯« JSONã€‚</p>
    </div>
  </div>

  <form method="POST" action="{% if editing and cmd %}{{ url_for('webui.edit_advanced_command', cmd_id=cmd.id) }}{% else %}{{ url_for('webui.create_advanced_command') }}{% endif %}">
    {{ form.hidden_tag() }}
    
    <div class="row mt-3">
      <!-- å·¦å´ï¼šåŸºæœ¬è³‡è¨Š -->
      <div class="col-md-2">
        <div class="card">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0">ğŸ“ æŒ‡ä»¤è³‡è¨Š</h5>
          </div>
          <div class="card-body">
            <div class="form-group">
              {{ form.name.label(class="form-label") }}
              {{ form.name(class="form-control", placeholder="ä¾‹ï¼šå·¡é‚è·¯ç·šA") }}
              {% if form.name.errors %}
                <div class="invalid-feedback d-block">
                  {% for error in form.name.errors %}<span>{{ error }}</span>{% endfor %}
                </div>
              {% endif %}
            </div>

            <div class="form-group mt-3">
              {{ form.category.label(class="form-label") }}
              {{ form.category(class="form-control", placeholder="ä¾‹ï¼šå·¡é‚") }}
              {% if form.category.errors %}
                <div class="invalid-feedback d-block">
                  {% for error in form.category.errors %}<span>{{ error }}</span>{% endfor %}
                </div>
              {% endif %}
            </div>

            <div class="form-group mt-3">
              {{ form.description.label(class="form-label") }}
              {{ form.description(class="form-control", rows=4, placeholder="æè¿°æŒ‡ä»¤çš„ç”¨é€”èˆ‡è¡Œç‚º...") }}
              {% if form.description.errors %}
                <div class="invalid-feedback d-block">
                  {% for error in form.description.errors %}<span>{{ error }}</span>{% endfor %}
                </div>
              {% endif %}
            </div>

            <div class="form-group mt-3">
              {{ form.version.label(class="form-label") }}
              {{ form.version(class="form-control", min=1) }}
              {% if form.version.errors %}
                <div class="invalid-feedback d-block">
                  {% for error in form.version.errors %}<span>{{ error }}</span>{% endfor %}
                </div>
              {% endif %}
            </div>

            <hr>

            <div class="alert alert-info">
              <strong>ğŸ“Š çµ±è¨ˆè³‡è¨Š</strong><br>
              ç©æœ¨æ•¸é‡ï¼š<span id="block-count">0</span><br>
              é ä¼°æ™‚é–“ï¼š<span id="estimated-time">0 ç§’</span>
            </div>

            <div class="d-grid gap-2 mt-3">
              {{ form.submit(class="btn btn-success btn-lg") }}
              <button type="button" class="btn btn-outline-secondary" onclick="clearWorkspace()">ğŸ—‘ï¸ æ¸…ç©º</button>
              <button type="button" class="btn btn-outline-primary" onclick="exportBlocks()">ğŸ’¾ åŒ¯å‡ºç©æœ¨</button>
              <button type="button" class="btn btn-outline-primary" onclick="importBlocks()">ğŸ“‚ åŒ¯å…¥ç©æœ¨</button>
            </div>
            <div class="mt-3">
              <label class="form-label">æ™‚é–“å–®ä½åå¥½</label>
              <div class="btn-group" role="group" aria-label="Duration unit">
                <input type="radio" class="btn-check" name="durationUnit" id="unit_s" autocomplete="off" {% if duration_unit == 's' %}checked{% endif %}>
                <label class="btn btn-outline-secondary" for="unit_s">ç§’ (s)</label>

                <input type="radio" class="btn-check" name="durationUnit" id="unit_ms" autocomplete="off" {% if duration_unit == 'ms' %}checked{% endif %}>
                <label class="btn btn-outline-secondary" for="unit_ms">æ¯«ç§’ (ms)</label>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- å·¦å´ç¬¬äºŒæ¬„ï¼šå¾…é©—è­‰ (To verify) -->
  <div id="verifyCol" class="col-md-3 {% if verify_collapsed %}collapsed{% endif %}">
        <div class="card">
          <div class="card-header bg-info text-white">
            <h5 class="mb-0">å¾…é©—è­‰ (To verify)
              <button id="verify-toggle" class="btn btn-sm btn-light ms-2 float-end" onclick="toggleVerifyPanel()" aria-expanded="true" title="æ‘ºç–Š/å±•é–‹å¾…é©—è­‰é¢æ¿">â–¾</button>
            </h5>
          </div>
          <div class="card-body">
            <div id="verify-panel" class="bg-light p-3" style="height: 600px; overflow-y: auto; font-size: 0.95rem; border-radius: 4px;">
              <h5>ğŸ” å¾…é©—è­‰ (To verify)</h5>
              <p id="verify-desc">æŒ‰ä¸‹ã€Œé©—è­‰æŒ‡ä»¤ã€ä¾†æª¢æŸ¥ç›®å‰å·¥ä½œå€çµ„åˆæ˜¯å¦ç¬¦åˆå¾Œç«¯å¥‘ç´„èˆ‡ç™½åå–®ã€‚</p>
              <div class="mt-3">
                <button type="button" class="btn btn-primary" onclick="validateCommands()">âœ… é©—è­‰æŒ‡ä»¤</button>
              </div>
              <hr>
              <div id="verify-result" style="white-space: pre-wrap; font-size:0.9rem;">å°šæœªé©—è­‰</div>
            </div>
          </div>
        </div>
      </div>

      <!-- ä¸­é–“ï¼šBlockly å·¥ä½œå€ï¼ˆæ“´å¤§å‘å³ï¼‰ -->
  <div class="col-md-7" id="blocklyCol">
        <div class="card">
          <div class="card-header bg-success text-white">
            <h5 class="mb-0">ğŸ§© ç©æœ¨å·¥ä½œå€</h5>
          </div>
          <div class="card-body p-0">
            <div id="blocklyDiv" style="height: 600px; width: 100%;"></div>
          </div>
        </div>
        
        <div class="alert alert-warning mt-3">
          <strong>ğŸ’¡ æç¤ºï¼š</strong>
          <ul class="mb-0">
            <li>å¾å·¦å´å·¥å…·ç®±æ‹–æ›³ç©æœ¨åˆ°å·¥ä½œå€</li>
            <li>ç©æœ¨å¯è‡ªç”±çµ„åˆã€æ’åºèˆ‡åˆªé™¤</li>
            <li>ä½¿ç”¨ã€Œé‡è¤‡ã€ç©æœ¨å¯å¾ªç’°åŸ·è¡Œå‹•ä½œ</li>
            <li>ä½¿ç”¨ã€Œç­‰å¾…ã€ç©æœ¨å¯åœ¨å‹•ä½œé–“æš«åœ</li>
          </ul>
        </div>
      </div>

      <!-- å³å´ï¼šç©ºç™½å ä½ï¼ˆä¿ç•™éŸ¿æ‡‰å¼é–“è·ï¼‰ -->
      <div class="col-md-0 d-none d-md-block"></div>
    </div>

    <!-- éš±è—æ¬„ä½ï¼šå„²å­˜ JSON èˆ‡ç©æœ¨ç‹€æ…‹ -->
    {{ form.base_commands(id="base_commands", style="display: none;") }}
    <input type="hidden" id="saved_blocks" name="saved_blocks" value="">
  </form>
</div>
{% endblock %}
