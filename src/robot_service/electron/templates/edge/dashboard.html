{% extends "edge/base.html" %}

{% block title %}æ©Ÿå™¨äººå„€è¡¨æ¿{% endblock %}

{% block content %}
<div class="page-header">
    <h1>ğŸ“Š æ©Ÿå™¨äººç›£æ§å„€è¡¨æ¿</h1>
    <p class="subtitle">ç›£æ§æ‰€æœ‰æœ¬åœ°æ©Ÿå™¨äººç‹€æ…‹</p>
</div>

<!-- æ‘˜è¦çµ±è¨ˆå¡ç‰‡ -->
<div id="summary-cards" class="summary-grid">
    <div class="summary-card summary-total">
        <div class="summary-icon">ğŸ¤–</div>
        <div class="summary-content">
            <span class="summary-value" id="total-robots">0</span>
            <span class="summary-label">æ©Ÿå™¨äººç¸½æ•¸</span>
        </div>
    </div>
    <div class="summary-card summary-connected">
        <div class="summary-icon">ğŸŸ¢</div>
        <div class="summary-content">
            <span class="summary-value" id="connected-robots">0</span>
            <span class="summary-label">å·²é€£ç·š</span>
        </div>
    </div>
    <div class="summary-card summary-healthy">
        <div class="summary-icon">âœ…</div>
        <div class="summary-content">
            <span class="summary-value" id="healthy-robots">0</span>
            <span class="summary-label">å¥åº·ç‹€æ…‹</span>
        </div>
    </div>
    <div class="summary-card summary-warning">
        <div class="summary-icon">âš ï¸</div>
        <div class="summary-content">
            <span class="summary-value" id="warning-robots">0</span>
            <span class="summary-label">éœ€è¦é—œæ³¨</span>
        </div>
    </div>
</div>

<div class="toolbar">
    <button class="btn btn-primary" onclick="showRegisterModal()">
        â• è¨»å†Šæ©Ÿå™¨äºº
    </button>
    <button class="btn btn-secondary" onclick="refreshRobots()">
        ğŸ”„ é‡æ–°æ•´ç†
    </button>
    <button class="btn btn-info" onclick="checkAllHealth()">
        ğŸ©º å¥åº·æª¢æŸ¥
    </button>
</div>

<div class="robots-grid" id="robots-container">
    {% if robots %}
        {% for robot in robots %}
        <div class="robot-card" data-robot-id="{{ robot.id }}">
            <div class="robot-header">
                <span class="robot-icon">{{ robot.icon or 'ğŸ¤–' }}</span>
                <h3 class="robot-name">{{ robot.name }}</h3>
                <span class="robot-status status-{{ robot.status }}">
                    {{ robot.status }}
                </span>
            </div>
            <div class="robot-body">
                <div class="robot-info">
                    <div class="info-row">
                        <span class="info-label">é¡å‹</span>
                        <span class="info-value">{{ robot.type_display or robot.type }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">é›»é‡</span>
                        <div class="battery-bar">
                            <div class="battery-level battery-{{ 'high' if robot.battery > 50 else 'medium' if robot.battery > 20 else 'low' }}" 
                                 style="width: {{ robot.battery }}%"></div>
                        </div>
                        <span class="info-value">{{ robot.battery }}%</span>
                    </div>
                    {% if robot.location %}
                    <div class="info-row">
                        <span class="info-label">ä½ç½®</span>
                        <span class="info-value">{{ robot.location }}</span>
                    </div>
                    {% endif %}
                    <div class="info-row">
                        <span class="info-label">é€£ç·š</span>
                        <span class="info-value">
                            {% if robot.connected %}
                            <span class="status-indicator status-success">ğŸŸ¢ å·²é€£ç·š</span>
                            {% else %}
                            <span class="status-indicator status-error">ğŸ”´ æœªé€£ç·š</span>
                            {% endif %}
                        </span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">å¥åº·</span>
                        <span class="info-value">
                            {% if robot.health_status == 'healthy' %}
                            <span class="health-badge health-healthy">âœ… å¥åº·</span>
                            {% elif robot.health_status == 'warning' %}
                            <span class="health-badge health-warning">âš ï¸ è­¦å‘Š</span>
                            {% else %}
                            <span class="health-badge health-unknown">â“ æœªçŸ¥</span>
                            {% endif %}
                        </span>
                    </div>
                </div>
            </div>
            <div class="robot-actions">
                <button class="btn btn-sm btn-primary" onclick="selectRobot('{{ robot.id }}')">
                    ğŸ® æ§åˆ¶
                </button>
                <button class="btn btn-sm btn-info" onclick="showDetailsModal('{{ robot.id }}')">
                    ğŸ“‹ è©³æƒ…
                </button>
                <button class="btn btn-sm btn-success" onclick="checkRobotHealth('{{ robot.id }}')">
                    ğŸ©º æª¢æŸ¥
                </button>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="empty-state">
            <div class="empty-icon">ğŸ¤–</div>
            <h3>å°šç„¡æ©Ÿå™¨äºº</h3>
            <p>é»æ“Šã€Œè¨»å†Šæ©Ÿå™¨äººã€æŒ‰éˆ•æ–°å¢æ‚¨çš„ç¬¬ä¸€å€‹æ©Ÿå™¨äºº</p>
            <button class="btn btn-primary" onclick="showRegisterModal()">
                â• è¨»å†Šæ©Ÿå™¨äºº
            </button>
        </div>
    {% endif %}
</div>

<!-- è¨»å†Šæ©Ÿå™¨äººå°è©±æ¡† -->
<div id="register-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2>â• è¨»å†Šæ©Ÿå™¨äºº</h2>
            <button class="modal-close" onclick="hideRegisterModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="register-form">
                <div class="form-group">
                    <label for="robot-name">æ©Ÿå™¨äººåç¨±</label>
                    <input type="text" id="robot-name" name="name" required placeholder="ä¾‹ï¼šæˆ‘çš„æ©Ÿå™¨äºº">
                </div>
                <div class="form-group">
                    <label for="robot-type">é¡å‹</label>
                    <select id="robot-type" name="type">
                        <option value="humanoid">ğŸ¤– äººå½¢æ©Ÿå™¨äºº</option>
                        <option value="agv">ğŸš— AGV æ¬é‹è»Š</option>
                        <option value="arm">ğŸ¦¾ æ©Ÿæ¢°æ‰‹è‡‚</option>
                        <option value="drone">ğŸš ç„¡äººæ©Ÿ</option>
                        <option value="other">âš™ï¸ å…¶ä»–</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="robot-location">ä½ç½®ï¼ˆå¯é¸ï¼‰</label>
                    <input type="text" id="robot-location" name="location" placeholder="ä¾‹ï¼šå¯¦é©—å®¤ A">
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="hideRegisterModal()">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="submitRegister()">è¨»å†Š</button>
        </div>
    </div>
</div>

<!-- æ©Ÿå™¨äººè©³æƒ…å°è©±æ¡† -->
<div id="details-modal" class="modal" style="display: none;">
    <div class="modal-content modal-lg">
        <div class="modal-header">
            <h2>ğŸ“‹ æ©Ÿå™¨äººè©³æƒ…</h2>
            <button class="modal-close" onclick="hideDetailsModal()">&times;</button>
        </div>
        <div class="modal-body" id="details-content">
            <div class="loading">è¼‰å…¥ä¸­...</div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-danger" onclick="confirmDeleteRobot()">ğŸ—‘ï¸ åˆªé™¤</button>
            <button class="btn btn-secondary" onclick="hideDetailsModal()">é—œé–‰</button>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
/* æ‘˜è¦çµ±è¨ˆå¡ç‰‡ */
.summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 15px;
    margin-bottom: 25px;
}

.summary-card {
    background: white;
    padding: 20px;
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow);
    display: flex;
    align-items: center;
    gap: 15px;
}

.summary-icon {
    font-size: 2em;
}

.summary-content {
    display: flex;
    flex-direction: column;
}

.summary-value {
    font-size: 1.8em;
    font-weight: 700;
    color: var(--dark);
}

.summary-label {
    font-size: 0.9em;
    color: var(--gray);
}

.summary-total { border-left: 4px solid var(--primary); }
.summary-connected { border-left: 4px solid var(--success); }
.summary-healthy { border-left: 4px solid var(--info); }
.summary-warning { border-left: 4px solid var(--warning); }

/* é›»é‡æ¢é¡è‰² */
.battery-level.battery-high { background: var(--success); }
.battery-level.battery-medium { background: var(--warning); }
.battery-level.battery-low { background: var(--danger); }

/* å¥åº·å¾½ç«  */
.health-badge {
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 0.85em;
}

.health-healthy { background: #d4edda; color: #155724; }
.health-warning { background: #fff3cd; color: #856404; }
.health-unknown { background: #e9ecef; color: #6c757d; }

/* å¤§å‹å°è©±æ¡† */
.modal-lg {
    max-width: 700px;
}

/* è©³æƒ…å…§å®¹ */
.details-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

.details-section {
    background: var(--light);
    padding: 15px;
    border-radius: var(--radius);
}

.details-section h4 {
    margin-bottom: 12px;
    color: var(--primary);
    padding-bottom: 8px;
    border-bottom: 2px solid var(--gray-light);
}

.details-row {
    display: flex;
    justify-content: space-between;
    padding: 6px 0;
}

.details-label {
    color: var(--gray);
}

.details-value {
    font-weight: 500;
}

.capabilities-list {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 10px;
}

.capability-tag {
    background: white;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 0.85em;
    border: 1px solid var(--gray-light);
}

.health-history {
    max-height: 200px;
    overflow-y: auto;
}

.health-history-item {
    padding: 8px;
    border-radius: var(--radius);
    margin-bottom: 8px;
    font-size: 0.9em;
}

.health-history-item.status-healthy { background: #d4edda; }
.health-history-item.status-warning { background: #fff3cd; }
.health-history-item.status-disconnected { background: #f8d7da; }
</style>
{% endblock %}

{% block scripts %}
<script>
let currentRobotId = null;

// HTML è·³è„«å‡½å¼ï¼ˆé˜²æ­¢ XSSï¼‰
function escapeHtml(text) {
    if (text === null || text === undefined) return '';
    const div = document.createElement('div');
    div.textContent = String(text);
    return div.innerHTML;
}

// é é¢è¼‰å…¥æ™‚åˆ·æ–°è³‡æ–™
document.addEventListener('DOMContentLoaded', function() {
    refreshRobots();
    loadSummary();
    // æ¯ 30 ç§’è‡ªå‹•åˆ·æ–°
    setInterval(refreshRobots, 30000);
    setInterval(loadSummary, 30000);
});

// è¼‰å…¥å„€è¡¨æ¿æ‘˜è¦
async function loadSummary() {
    try {
        const res = await fetch('/api/edge/dashboard/summary');
        const data = await res.json();
        const summary = data.summary;
        
        document.getElementById('total-robots').textContent = summary.total_robots;
        document.getElementById('connected-robots').textContent = summary.connected;
        document.getElementById('healthy-robots').textContent = summary.healthy;
        // ä½¿ç”¨å¾Œç«¯è¨ˆç®—çš„ needs_attention é¿å…é‡è¤‡è¨ˆæ•¸
        document.getElementById('warning-robots').textContent = summary.needs_attention;
    } catch (error) {
        console.error('Failed to load summary:', error);
    }
}

// é‡æ–°æ•´ç†æ©Ÿå™¨äººåˆ—è¡¨
async function refreshRobots() {
    try {
        const res = await fetch('/api/edge/robots');
        const data = await res.json();
        
        renderRobots(data.robots || []);
        loadSummary();
    } catch (error) {
        console.error('Failed to refresh robots:', error);
    }
}

// æ¸²æŸ“æ©Ÿå™¨äººåˆ—è¡¨
function renderRobots(robots) {
    const container = document.getElementById('robots-container');
    
    if (robots.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">ğŸ¤–</div>
                <h3>å°šç„¡æ©Ÿå™¨äºº</h3>
                <p>é»æ“Šã€Œè¨»å†Šæ©Ÿå™¨äººã€æŒ‰éˆ•æ–°å¢æ‚¨çš„ç¬¬ä¸€å€‹æ©Ÿå™¨äºº</p>
                <button class="btn btn-primary" onclick="showRegisterModal()">
                    â• è¨»å†Šæ©Ÿå™¨äºº
                </button>
            </div>
        `;
        return;
    }
    
    container.innerHTML = robots.map(robot => `
        <div class="robot-card" data-robot-id="${escapeHtml(robot.id)}">
            <div class="robot-header">
                <span class="robot-icon">${escapeHtml(robot.icon) || 'ğŸ¤–'}</span>
                <h3 class="robot-name">${escapeHtml(robot.name)}</h3>
                <span class="robot-status status-${escapeHtml(robot.status)}">
                    ${escapeHtml(robot.status)}
                </span>
            </div>
            <div class="robot-body">
                <div class="robot-info">
                    <div class="info-row">
                        <span class="info-label">é¡å‹</span>
                        <span class="info-value">${escapeHtml(robot.type_display || robot.type)}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">é›»é‡</span>
                        <div class="battery-bar">
                            <div class="battery-level battery-${robot.battery > 50 ? 'high' : robot.battery > 20 ? 'medium' : 'low'}" 
                                 style="width: ${Number(robot.battery) || 0}%"></div>
                        </div>
                        <span class="info-value">${escapeHtml(robot.battery)}%</span>
                    </div>
                    ${robot.location ? `
                    <div class="info-row">
                        <span class="info-label">ä½ç½®</span>
                        <span class="info-value">${escapeHtml(robot.location)}</span>
                    </div>
                    ` : ''}
                    <div class="info-row">
                        <span class="info-label">é€£ç·š</span>
                        <span class="info-value">
                            ${robot.connected 
                                ? '<span class="status-indicator status-success">ğŸŸ¢ å·²é€£ç·š</span>'
                                : '<span class="status-indicator status-error">ğŸ”´ æœªé€£ç·š</span>'}
                        </span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">å¥åº·</span>
                        <span class="info-value">
                            ${getHealthBadge(robot.health_status)}
                        </span>
                    </div>
                </div>
            </div>
            <div class="robot-actions">
                <button class="btn btn-sm btn-primary" onclick="selectRobot('${escapeHtml(robot.id)}')">
                    ğŸ® æ§åˆ¶
                </button>
                <button class="btn btn-sm btn-info" onclick="showDetailsModal('${escapeHtml(robot.id)}')">
                    ğŸ“‹ è©³æƒ…
                </button>
                <button class="btn btn-sm btn-success" onclick="checkRobotHealth('${escapeHtml(robot.id)}')">
                    ğŸ©º æª¢æŸ¥
                </button>
            </div>
        </div>
    `).join('');
}

// å–å¾—å¥åº·å¾½ç«  HTML
function getHealthBadge(status) {
    switch (status) {
        case 'healthy':
            return '<span class="health-badge health-healthy">âœ… å¥åº·</span>';
        case 'warning':
            return '<span class="health-badge health-warning">âš ï¸ è­¦å‘Š</span>';
        default:
            return '<span class="health-badge health-unknown">â“ æœªçŸ¥</span>';
    }
}

// é¡¯ç¤ºè¨»å†Šå°è©±æ¡†
function showRegisterModal() {
    document.getElementById('register-modal').style.display = 'flex';
}

// éš±è—è¨»å†Šå°è©±æ¡†
function hideRegisterModal() {
    document.getElementById('register-modal').style.display = 'none';
    document.getElementById('register-form').reset();
}

// æäº¤è¨»å†Š
async function submitRegister() {
    const form = document.getElementById('register-form');
    const formData = new FormData(form);
    
    const robotData = {
        name: formData.get('name'),
        type: formData.get('type'),
        location: formData.get('location') || null,
    };
    
    try {
        const res = await fetch('/api/edge/robots', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(robotData)
        });
        
        const data = await res.json();
        if (data.success) {
            hideRegisterModal();
            refreshRobots();
            window.EdgeUI.showToast('æ©Ÿå™¨äººè¨»å†ŠæˆåŠŸ');
        } else {
            window.EdgeUI.showToast('è¨»å†Šå¤±æ•—: ' + (data.error || 'æœªçŸ¥éŒ¯èª¤'), 'error');
        }
    } catch (error) {
        console.error('Failed to register robot:', error);
        window.EdgeUI.showToast('è¨»å†Šå¤±æ•—', 'error');
    }
}

// é¸æ“‡æ©Ÿå™¨äººï¼ˆå°å‘æ§åˆ¶ä¸­å¿ƒï¼‰
function selectRobot(robotId) {
    window.location.href = `/ui/command-center?robot=${robotId}`;
}

// åŸ·è¡Œå–®ä¸€æ©Ÿå™¨äººå¥åº·æª¢æŸ¥
async function checkRobotHealth(robotId) {
    try {
        window.EdgeUI.showToast('æ­£åœ¨åŸ·è¡Œå¥åº·æª¢æŸ¥...', 'info');
        const res = await fetch(`/api/edge/robots/${robotId}/health`);
        const data = await res.json();
        
        if (data.health.status === 'healthy') {
            window.EdgeUI.showToast('âœ… æ©Ÿå™¨äººå¥åº·ç‹€æ…‹è‰¯å¥½', 'success');
        } else if (data.health.status === 'warning') {
            window.EdgeUI.showToast('âš ï¸ æ©Ÿå™¨äººéœ€è¦é—œæ³¨', 'warning');
        } else {
            window.EdgeUI.showToast('â“ æ©Ÿå™¨äººç‹€æ…‹æœªçŸ¥', 'info');
        }
        
        refreshRobots();
    } catch (error) {
        console.error('Failed to check health:', error);
        window.EdgeUI.showToast('å¥åº·æª¢æŸ¥å¤±æ•—', 'error');
    }
}

// åŸ·è¡Œæ‰€æœ‰æ©Ÿå™¨äººå¥åº·æª¢æŸ¥
async function checkAllHealth() {
    try {
        const res = await fetch('/api/edge/robots');
        const data = await res.json();
        
        if (!data.robots || data.robots.length === 0) {
            window.EdgeUI.showToast('æ²’æœ‰æ©Ÿå™¨äººéœ€è¦æª¢æŸ¥', 'info');
            return;
        }
        
        window.EdgeUI.showToast(`æ­£åœ¨æª¢æŸ¥ ${data.robots.length} å€‹æ©Ÿå™¨äºº...`, 'info');
        
        for (const robot of data.robots) {
            await fetch(`/api/edge/robots/${robot.id}/health`);
        }
        
        refreshRobots();
        window.EdgeUI.showToast('å¥åº·æª¢æŸ¥å®Œæˆ', 'success');
    } catch (error) {
        console.error('Failed to check all health:', error);
        window.EdgeUI.showToast('å¥åº·æª¢æŸ¥å¤±æ•—', 'error');
    }
}

// é¡¯ç¤ºè©³æƒ…å°è©±æ¡†
async function showDetailsModal(robotId) {
    currentRobotId = robotId;
    document.getElementById('details-modal').style.display = 'flex';
    document.getElementById('details-content').innerHTML = '<div class="loading">è¼‰å…¥ä¸­...</div>';
    
    try {
        // è¼‰å…¥æ©Ÿå™¨äººè³‡æ–™
        const robotRes = await fetch(`/api/edge/robots/${robotId}`);
        const robotData = await robotRes.json();
        
        // è¼‰å…¥å¥åº·æ­·å²
        const historyRes = await fetch(`/api/edge/robots/${robotId}/health/history?limit=5`);
        const historyData = await historyRes.json();
        
        renderDetails(robotData.robot, historyData.history);
    } catch (error) {
        console.error('Failed to load robot details:', error);
        document.getElementById('details-content').innerHTML = '<div class="error">è¼‰å…¥å¤±æ•—</div>';
    }
}

// æ¸²æŸ“è©³æƒ…å…§å®¹
function renderDetails(robot, healthHistory) {
    const content = document.getElementById('details-content');
    
    content.innerHTML = `
        <div class="details-grid">
            <div class="details-section">
                <h4>${escapeHtml(robot.icon) || 'ğŸ¤–'} åŸºæœ¬è³‡è¨Š</h4>
                <div class="details-row">
                    <span class="details-label">åç¨±</span>
                    <span class="details-value">${escapeHtml(robot.name)}</span>
                </div>
                <div class="details-row">
                    <span class="details-label">ID</span>
                    <span class="details-value">${escapeHtml(robot.id)}</span>
                </div>
                <div class="details-row">
                    <span class="details-label">é¡å‹</span>
                    <span class="details-value">${escapeHtml(robot.type_display || robot.type)}</span>
                </div>
                <div class="details-row">
                    <span class="details-label">ä½ç½®</span>
                    <span class="details-value">${escapeHtml(robot.location) || '-'}</span>
                </div>
                <div class="details-row">
                    <span class="details-label">å»ºç«‹æ™‚é–“</span>
                    <span class="details-value">${robot.created_at ? window.EdgeUI.formatDateTime(robot.created_at) : '-'}</span>
                </div>
            </div>
            
            <div class="details-section">
                <h4>ğŸ“Š ç‹€æ…‹è³‡è¨Š</h4>
                <div class="details-row">
                    <span class="details-label">ç‹€æ…‹</span>
                    <span class="details-value">${escapeHtml(robot.status)}</span>
                </div>
                <div class="details-row">
                    <span class="details-label">é€£ç·š</span>
                    <span class="details-value">${robot.connected ? 'ğŸŸ¢ å·²é€£ç·š' : 'ğŸ”´ æœªé€£ç·š'}</span>
                </div>
                <div class="details-row">
                    <span class="details-label">é›»é‡</span>
                    <span class="details-value">${escapeHtml(robot.battery)}%</span>
                </div>
                <div class="details-row">
                    <span class="details-label">å¥åº·ç‹€æ…‹</span>
                    <span class="details-value">${getHealthBadge(robot.health_status)}</span>
                </div>
                <div class="details-row">
                    <span class="details-label">æœ€å¾Œé€£ç·š</span>
                    <span class="details-value">${robot.last_seen ? window.EdgeUI.formatDateTime(robot.last_seen) : '-'}</span>
                </div>
            </div>
        </div>
        
        <div class="details-section" style="margin-top: 15px;">
            <h4>ğŸ› ï¸ èƒ½åŠ›æ¸…å–®</h4>
            <div class="capabilities-list">
                ${(robot.capabilities || []).map(cap => `
                    <span class="capability-tag">${escapeHtml(cap)}</span>
                `).join('')}
            </div>
        </div>
        
        <div class="details-section" style="margin-top: 15px;">
            <h4>ğŸ©º å¥åº·æª¢æŸ¥æ­·å²</h4>
            <div class="health-history">
                ${healthHistory.length > 0 ? healthHistory.map(h => `
                    <div class="health-history-item status-${escapeHtml(h.status)}">
                        <strong>${escapeHtml(h.status)}</strong> - ${window.EdgeUI.formatDateTime(h.timestamp)}
                        ${h.response_time_ms ? `(${escapeHtml(h.response_time_ms)}ms)` : ''}
                    </div>
                `).join('') : '<p>å°šç„¡å¥åº·æª¢æŸ¥è¨˜éŒ„</p>'}
            </div>
        </div>
    `;
}

// éš±è—è©³æƒ…å°è©±æ¡†
function hideDetailsModal() {
    document.getElementById('details-modal').style.display = 'none';
    currentRobotId = null;
}

// ç¢ºèªåˆªé™¤æ©Ÿå™¨äºº
async function confirmDeleteRobot() {
    if (!currentRobotId) return;
    
    const confirmed = await window.EdgeUI.confirmAction('ç¢ºå®šè¦åˆªé™¤é€™å€‹æ©Ÿå™¨äººå—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚');
    if (!confirmed) return;
    
    try {
        const res = await fetch(`/api/edge/robots/${currentRobotId}`, {
            method: 'DELETE'
        });
        
        const data = await res.json();
        if (data.success) {
            hideDetailsModal();
            refreshRobots();
            window.EdgeUI.showToast('æ©Ÿå™¨äººå·²åˆªé™¤');
        } else {
            window.EdgeUI.showToast('åˆªé™¤å¤±æ•—: ' + (data.error || 'æœªçŸ¥éŒ¯èª¤'), 'error');
        }
    } catch (error) {
        console.error('Failed to delete robot:', error);
        window.EdgeUI.showToast('åˆªé™¤å¤±æ•—', 'error');
    }
}
</script>
{% endblock %}
