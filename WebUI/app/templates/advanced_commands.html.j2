{% extends "base.html.j2" %}
{% block app_content %}
<h2>進階指令分享區</h2>
<p>這裡展示用戶基於基礎指令組合的進階指令範例，經審核後可供其他用戶參考與使用。</p>

{% if current_user.is_authenticated %}
<div class="row" style="margin-bottom: 15px;">
  <div class="col-md-8">
    {% if current_user.is_admin() %}
    <!-- 篩選與排序控制（僅 Admin/Auditor 可見） -->
    <form method="get" action="{{ url_for('webui.advanced_commands') }}" class="form-inline">
      <div class="form-group" style="margin-right: 10px;">
        <label for="status" style="margin-right: 5px;">狀態：</label>
        <select name="status" id="status" class="form-control" onchange="this.form.submit()">
          <option value="all" {% if filter_status == 'all' %}selected{% endif %}>全部</option>
          <option value="pending" {% if filter_status == 'pending' %}selected{% endif %}>待審核</option>
          <option value="approved" {% if filter_status == 'approved' %}selected{% endif %}>已批准</option>
          <option value="rejected" {% if filter_status == 'rejected' %}selected{% endif %}>已拒絕</option>
        </select>
      </div>
      <div class="form-group" style="margin-right: 10px;">
        <label for="sort" style="margin-right: 5px;">排序：</label>
        <select name="sort" id="sort" class="form-control" onchange="this.form.submit()">
          <option value="created_at" {% if sort_by == 'created_at' %}selected{% endif %}>建立時間</option>
          <option value="updated_at" {% if sort_by == 'updated_at' %}selected{% endif %}>更新時間</option>
          <option value="name" {% if sort_by == 'name' %}selected{% endif %}>名稱</option>
          <option value="category" {% if sort_by == 'category' %}selected{% endif %}>分類</option>
          <option value="author" {% if sort_by == 'author' %}selected{% endif %}>作者</option>
        </select>
      </div>
      <div class="form-group">
        <label for="order" style="margin-right: 5px;">順序：</label>
        <select name="order" id="order" class="form-control" onchange="this.form.submit()">
          <option value="desc" {% if sort_order == 'desc' %}selected{% endif %}>降序</option>
          <option value="asc" {% if sort_order == 'asc' %}selected{% endif %}>升序</option>
        </select>
      </div>
    </form>
    {% endif %}
  </div>
  <div class="col-md-4 text-right">
    <a href="{{ url_for('webui.create_advanced_command') }}" class="btn btn-primary">建立進階指令</a>
  </div>
</div>
{% else %}
<div class="text-right" style="margin-bottom: 15px;">
  <a href="{{ url_for('webui.login') }}" class="btn btn-primary">登入以建立指令</a>
</div>
{% endif %}

<div class="panel-group" id="accordion">
  {% for cmd in commands %}
  <div class="panel panel-default">
    <div class="panel-heading">
      <h4 class="panel-title">
        <a data-toggle="collapse" data-parent="#accordion" href="#collapse{{ cmd.id }}">
          <strong>{{ cmd.name|e }}</strong> 
          <small class="text-muted">v{{ cmd.version or 1 }}</small>
          <span class="label label-{{ 'success' if cmd.status == 'approved' else ('warning' if cmd.status == 'pending' else 'danger') }}">
            {{ '已批准' if cmd.status == 'approved' else ('待審核' if cmd.status == 'pending' else '已拒絕') }}
          </span>
          <small class="text-muted">分類：{{ cmd.category|e }}</small>
        </a>
      </h4>
    </div>
    <div id="collapse{{ cmd.id }}" class="panel-collapse collapse">
      <div class="panel-body">
  <p><strong>描述：</strong>{{ cmd.description|e }}</p>
  <p><strong>作者：</strong>{{ cmd.author.username|e if cmd.author else '未知' }}</p>
  <p><strong>建立時間：</strong>{{ cmd.created_at.strftime('%Y-%m-%d %H:%M') if cmd.created_at else '未知' }}</p>
  <p><strong>版本：</strong>v{{ cmd.version or 1 }} {% if cmd.updated_at and cmd.updated_at != cmd.created_at %}（最後更新版本於 {{ cmd.updated_at.strftime('%Y-%m-%d %H:%M') }}）{% endif %}</p>
        {% if cmd.updated_at and cmd.updated_at != cmd.created_at %}
        <p><strong>更新時間：</strong>{{ cmd.updated_at.strftime('%Y-%m-%d %H:%M') }}</p>
        {% endif %}
        <p><strong>基礎指令序列：</strong></p>
  <pre>{{ cmd.base_commands|e }}</pre>
        {% if current_user.is_authenticated and current_user.is_admin() and cmd.status == 'pending' %}
        <hr>
        <form method="post" action="{{ url_for('webui.audit_advanced_command', cmd_id=cmd.id) }}" style="display:inline;">
          <input type="hidden" name="action" value="approve">
          <button type="submit" class="btn btn-success btn-sm">批准</button>
        </form>
        <form method="post" action="{{ url_for('webui.audit_advanced_command', cmd_id=cmd.id) }}" style="display:inline;">
          <input type="hidden" name="action" value="reject">
          <button type="submit" class="btn btn-danger btn-sm">拒絕</button>
        </form>
        {% endif %}
  {% if current_user.is_authenticated and (current_user.is_admin() or cmd.author_id == current_user.id) %}
  <a href="{{ url_for('webui.edit_advanced_command', cmd_id=cmd.id) }}" class="btn btn-outline-primary btn-sm">編輯</a>
  {% endif %}
      </div>
    </div>
  </div>
  {% endfor %}
  {% if commands|length == 0 %}
  <div class="alert alert-info">
    <p>目前沒有符合條件的進階指令。</p>
  </div>
  {% endif %}
</div>
{% endblock %}
