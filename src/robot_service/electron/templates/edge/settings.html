{% extends "edge/base.html" %}

{% block title %}ç”¨æˆ¶è¨­å®š{% endblock %}

{% block content %}
<div class="page-header">
    <h1>âš™ï¸ ç”¨æˆ¶è¨­å®š</h1>
    <p class="subtitle">èª¿æ•´æœ¬åœ°åå¥½è¨­å®š</p>
</div>

<div class="settings-container">
    <!-- UI è¨­å®š -->
    <div class="settings-section">
        <h2>ğŸ¨ ä»‹é¢è¨­å®š</h2>
        
        <div class="setting-item">
            <div class="setting-info">
                <label>æ™‚é–“å–®ä½</label>
                <p class="setting-desc">é¸æ“‡é€²éšæŒ‡ä»¤ç·¨è¼¯å™¨ä¸­çš„æ™‚é–“é¡¯ç¤ºå–®ä½</p>
            </div>
            <div class="setting-control">
                <select id="duration-unit" onchange="saveSetting('duration_unit', this.value)">
                    <option value="s">ç§’ (s)</option>
                    <option value="ms">æ¯«ç§’ (ms)</option>
                </select>
            </div>
        </div>
        
        <div class="setting-item">
            <div class="setting-info">
                <label>ä¸»é¡Œ</label>
                <p class="setting-desc">é¸æ“‡ä»‹é¢ä¸»é¡Œ</p>
            </div>
            <div class="setting-control">
                <select id="theme" onchange="saveSetting('theme', this.value)">
                    <option value="light">æ·ºè‰²</option>
                    <option value="dark">æ·±è‰²</option>
                    <option value="auto">è‡ªå‹•</option>
                </select>
            </div>
        </div>
    </div>
    
    <!-- LLM åå¥½ -->
    <div class="settings-section">
        <h2>ğŸ§  LLM åå¥½</h2>
        
        <div class="setting-item">
            <div class="setting-info">
                <label>é è¨­æä¾›å•†</label>
                <p class="setting-desc">é¸æ“‡é è¨­çš„ LLM æä¾›å•†</p>
            </div>
            <div class="setting-control">
                <select id="llm-provider" onchange="saveSetting('llm_provider', this.value)">
                    <option value="">æœªè¨­å®š</option>
                    <option value="ollama">Ollama</option>
                    <option value="lmstudio">LM Studio</option>
                </select>
            </div>
        </div>
        
        <div class="setting-item">
            <div class="setting-info">
                <label>é è¨­æ¨¡å‹</label>
                <p class="setting-desc">è¼¸å…¥é è¨­ä½¿ç”¨çš„æ¨¡å‹åç¨±</p>
            </div>
            <div class="setting-control">
                <input type="text" id="llm-model" placeholder="ä¾‹ï¼šllama2:latest" 
                       onchange="saveSetting('llm_model', this.value)">
            </div>
        </div>
    </div>
    
    <!-- é—œæ–¼ -->
    <div class="settings-section">
        <h2>â„¹ï¸ é—œæ–¼</h2>
        
        <div class="about-info">
            <p><strong>Robot Command Console - Edge App</strong></p>
            <p>ç‰ˆæœ¬ï¼šPhase 3.2</p>
            <p>æœ¬åœ° WebUI ç§»æ¤ç‰ˆæœ¬</p>
        </div>
        
        <div class="action-buttons">
            <button class="btn btn-secondary" onclick="resetSettings()">
                ğŸ”„ é‡è¨­æ‰€æœ‰è¨­å®š
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// é é¢è¼‰å…¥æ™‚è¼‰å…¥è¨­å®š
document.addEventListener('DOMContentLoaded', loadSettings);

// è¼‰å…¥è¨­å®š
async function loadSettings() {
    try {
        const res = await fetch('/api/edge/settings');
        const data = await res.json();
        
        if (data.settings) {
            document.getElementById('duration-unit').value = data.settings.duration_unit || 's';
            document.getElementById('theme').value = data.settings.theme || 'light';
            document.getElementById('llm-provider').value = data.settings.llm_provider || '';
            document.getElementById('llm-model').value = data.settings.llm_model || '';
        }
    } catch (error) {
        console.error('Failed to load settings:', error);
    }
}

// å„²å­˜è¨­å®š
async function saveSetting(key, value) {
    try {
        const settings = {};
        settings[key] = value;
        
        const res = await fetch('/api/edge/settings', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(settings)
        });
        
        const data = await res.json();
        if (data.success) {
            window.EdgeUI.showToast('è¨­å®šå·²å„²å­˜');
        }
    } catch (error) {
        console.error('Failed to save setting:', error);
        window.EdgeUI.showToast('å„²å­˜å¤±æ•—', 'error');
    }
}

// é‡è¨­è¨­å®š
async function resetSettings() {
    if (!confirm('ç¢ºå®šè¦é‡è¨­æ‰€æœ‰è¨­å®šå—ï¼Ÿ')) {
        return;
    }
    
    try {
        // å…ˆå¾å¾Œç«¯å–å¾—é è¨­å€¼
        const defaultsRes = await fetch('/api/edge/settings/defaults');
        const defaultsData = await defaultsRes.json();
        if (!defaultsData || !defaultsData.settings) {
            window.EdgeUI.showToast('å–å¾—é è¨­å€¼å¤±æ•—', 'error');
            return;
        }
        
        // ç”¨é è¨­å€¼é‡è¨­è¨­å®š
        const res = await fetch('/api/edge/settings', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(defaultsData.settings)
        });
        
        const data = await res.json();
        if (data.success) {
            loadSettings();
            window.EdgeUI.showToast('è¨­å®šå·²é‡è¨­');
        } else {
            window.EdgeUI.showToast('é‡è¨­å¤±æ•—', 'error');
        }
    } catch (error) {
        console.error('Failed to reset settings:', error);
        window.EdgeUI.showToast('é‡è¨­å¤±æ•—', 'error');
    }
}
</script>
{% endblock %}
