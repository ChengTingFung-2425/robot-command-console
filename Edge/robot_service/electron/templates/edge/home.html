{% extends "edge/base.html" %}

{% block title %}é¦–é {% endblock %}

{% block content %}
<div class="page-header">
    <h1>ğŸ¤– Robot Command Console</h1>
    <p class="subtitle">Edge æœ¬åœ°æ§åˆ¶ä¸­å¿ƒ</p>
</div>

<div class="card-grid">
    <div class="card card-primary">
        <div class="card-icon">ğŸ“Š</div>
        <h3>æ©Ÿå™¨äººå„€è¡¨æ¿</h3>
        <p>ç›£æ§æ‰€æœ‰æœ¬åœ°æ©Ÿå™¨äººçš„å³æ™‚ç‹€æ…‹ã€é›»é‡å’Œä½ç½®ã€‚</p>
        <a href="{{ url_for('edge_ui.ui_dashboard') }}" class="btn btn-primary">é–‹å•Ÿå„€è¡¨æ¿</a>
    </div>

    <div class="card card-success">
        <div class="card-icon">ğŸ®</div>
        <h3>æŒ‡ä»¤æ§åˆ¶ä¸­å¿ƒ</h3>
        <p>é¸æ“‡æ©Ÿå™¨äººä¸¦ç™¼é€å‹•ä½œæŒ‡ä»¤ï¼Œå³æ™‚ç›£æ§åŸ·è¡Œç‹€æ…‹ã€‚</p>
        <a href="{{ url_for('edge_ui.ui_command_center') }}" class="btn btn-success">é–‹å•Ÿæ§åˆ¶ä¸­å¿ƒ</a>
    </div>

    <div class="card card-info">
        <div class="card-icon">ğŸ§ </div>
        <h3>LLM è¨­å®š</h3>
        <p>ç®¡ç†æœ¬åœ° LLM æä¾›å•†ï¼ˆOllama / LM Studioï¼‰ã€‚</p>
        <a href="{{ url_for('edge_ui.ui_llm_settings') }}" class="btn btn-info">LLM è¨­å®š</a>
    </div>

    <div class="card card-warning">
        <div class="card-icon">âš™ï¸</div>
        <h3>ç”¨æˆ¶è¨­å®š</h3>
        <p>èª¿æ•´ UI åå¥½ã€æ™‚é–“å–®ä½ç­‰æœ¬åœ°è¨­å®šã€‚</p>
        <a href="{{ url_for('edge_ui.ui_settings') }}" class="btn btn-warning">é–‹å•Ÿè¨­å®š</a>
    </div>
</div>

<div class="section">
    <h2>ğŸ“¡ ç³»çµ±ç‹€æ…‹</h2>
    <div class="status-grid" id="system-status">
        <div class="status-card" id="flask-status">
            <span class="status-icon">ğŸ”Œ</span>
            <span class="status-label">Flask Service</span>
            <span class="status-value status-success">é‹è¡Œä¸­</span>
        </div>
        <div class="status-card" id="llm-status">
            <span class="status-icon">ğŸ§ </span>
            <span class="status-label">æœ¬åœ° LLM</span>
            <span class="status-value status-checking">æª¢æŸ¥ä¸­...</span>
        </div>
        <div class="status-card" id="internet-status">
            <span class="status-icon">ğŸŒ</span>
            <span class="status-label">ç¶²è·¯é€£ç·š</span>
            <span class="status-value status-checking">æª¢æŸ¥ä¸­...</span>
        </div>
        <div class="status-card" id="robots-status">
            <span class="status-icon">ğŸ¤–</span>
            <span class="status-label">æ©Ÿå™¨äººæ•¸é‡</span>
            <span class="status-value">0</span>
        </div>
    </div>
</div>

<div class="section">
    <h2>â˜ï¸ é›²ç«¯åŒæ­¥ç‹€æ…‹</h2>
    <div class="status-grid" id="sync-status">
        <div class="status-card" id="sync-network-status">
            <span class="status-icon">ğŸŒ</span>
            <span class="status-label">ç¶²è·¯é€£ç·š</span>
            <span class="status-value status-checking">æª¢æŸ¥ä¸­...</span>
        </div>
        <div class="status-card" id="sync-queue-status">
            <span class="status-icon">ğŸ“®</span>
            <span class="status-label">ä½‡åˆ—æœå‹™</span>
            <span class="status-value status-checking">æª¢æŸ¥ä¸­...</span>
        </div>
        <div class="status-card" id="sync-buffer-status">
            <span class="status-icon">ğŸ’¾</span>
            <span class="status-label">ç·©è¡å€</span>
            <span class="status-value status-checking">æª¢æŸ¥ä¸­...</span>
        </div>
        <div class="status-card" id="sync-last-sync">
            <span class="status-icon">ğŸ”„</span>
            <span class="status-label">æœ€å¾ŒåŒæ­¥</span>
            <span class="status-value">--</span>
        </div>
    </div>
</div>

<div class="section">
    <h2>ğŸš€ å¿«é€Ÿæ“ä½œ</h2>
    <div class="action-buttons">
        <button class="btn btn-lg btn-primary" onclick="registerDemoRobot()">
            â• è¨»å†Šç¤ºç¯„æ©Ÿå™¨äºº
        </button>
        <button class="btn btn-lg btn-secondary" onclick="refreshStatus()">
            ğŸ”„ é‡æ–°æ•´ç†ç‹€æ…‹
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// é é¢è¼‰å…¥æ™‚æª¢æŸ¥ç‹€æ…‹
document.addEventListener('DOMContentLoaded', function() {
    refreshStatus();
    // ç«‹å³æ›´æ–°åŒæ­¥ç‹€æ…‹ï¼ˆå³ä½¿ refreshStatus å¤±æ•—ä¹Ÿèƒ½é¡¯ç¤ºï¼‰
    updateSyncStatus();

    // å®šæœŸæ›´æ–°ç‹€æ…‹ï¼ˆæ¯ 30 ç§’ï¼‰
    setInterval(refreshStatus, 30000);

    // å®šæœŸæ›´æ–°é›²ç«¯åŒæ­¥ç‹€æ…‹ï¼ˆæ¯ 10 ç§’ï¼‰
    setInterval(updateSyncStatus, 10000);
});

// é‡æ–°æ•´ç†ç‹€æ…‹
async function refreshStatus() {
    try {
        // æª¢æŸ¥ LLM ç‹€æ…‹
        const llmRes = await fetch('/api/edge/llm/status');
        const llmData = await llmRes.json();

        const llmStatus = document.querySelector('#llm-status .status-value');
        if (llmData.local_llm_available) {
            llmStatus.textContent = 'å¯ç”¨';
            llmStatus.className = 'status-value status-success';
        } else {
            llmStatus.textContent = 'ä¸å¯ç”¨';
            llmStatus.className = 'status-value status-error';
        }

        const internetStatus = document.querySelector('#internet-status .status-value');
        if (llmData.internet_available) {
            internetStatus.textContent = 'å·²é€£ç·š';
            internetStatus.className = 'status-value status-success';
        } else {
            internetStatus.textContent = 'é›¢ç·š';
            internetStatus.className = 'status-value status-warning';
        }

        // æª¢æŸ¥æ©Ÿå™¨äººæ•¸é‡
        const robotsRes = await fetch('/api/edge/robots');
        const robotsData = await robotsRes.json();

        const robotsStatus = document.querySelector('#robots-status .status-value');
        robotsStatus.textContent = robotsData.count;

        // æ›´æ–°é›²ç«¯åŒæ­¥ç‹€æ…‹
        await updateSyncStatus();

        // æ›´æ–°å°èˆªåˆ—ç‹€æ…‹ï¼ˆå‘¼å« EdgeUI å…±ç”¨å‡½å¼ï¼‰
        if (window.EdgeUI && typeof window.EdgeUI.updateConnectionStatus === 'function') {
            window.EdgeUI.updateConnectionStatus();
        }

    } catch (error) {
        console.error('Failed to refresh status:', error);
    }
}

// æ›´æ–°é›²ç«¯åŒæ­¥ç‹€æ…‹
async function updateSyncStatus() {
    try {
        const res = await fetch('/api/edge/sync/status');
        const data = await res.json();

        // æ›´æ–°ç¶²è·¯ç‹€æ…‹
        const networkStatus = document.querySelector('#sync-network-status .status-value');
        if (data.network.online) {
            networkStatus.textContent = 'åœ¨ç·š';
            networkStatus.className = 'status-value status-success';
        } else {
            networkStatus.textContent = 'é›¢ç·š';
            networkStatus.className = 'status-value status-warning';
        }

        // æ›´æ–°ä½‡åˆ—æœå‹™ç‹€æ…‹
        const queueStatus = document.querySelector('#sync-queue-status .status-value');
        if (data.services.queue.available) {
            queueStatus.textContent = 'å¯ç”¨';
            queueStatus.className = 'status-value status-success';
        } else {
            queueStatus.textContent = 'ä¸å¯ç”¨';
            // é›¢ç·šå°è‡´ä¸å¯ç”¨ â†’ warningï¼›åœ¨ç·šä½†æœå‹™æ•…éšœ â†’ error
            if (data.network && data.network.online === false) {
                queueStatus.className = 'status-value status-warning';
            } else {
                queueStatus.className = 'status-value status-error';
            }
        }

        // æ›´æ–°ç·©è¡å€ç‹€æ…‹
        const bufferStatus = document.querySelector('#sync-buffer-status .status-value');
        const totalPending = data.buffers.command.pending + data.buffers.sync.pending;
        if (totalPending === 0) {
            bufferStatus.textContent = 'ç©ºé–’';
            bufferStatus.className = 'status-value status-success';
        } else {
            bufferStatus.textContent = `${totalPending} é …å¾…åŒæ­¥`;
            bufferStatus.className = 'status-value status-warning';
        }

        // æ›´æ–°æœ€å¾Œæª¢æŸ¥æ™‚é–“
        const lastSyncStatus = document.querySelector('#sync-last-sync .status-value');
        if (data.last_checked) {
            const lastCheckedTime = new Date(data.last_checked);
            lastSyncStatus.textContent = window.EdgeUI.formatTime(lastCheckedTime);
        } else {
            lastSyncStatus.textContent = '--';
        }

    } catch (error) {
        console.error('Failed to update sync status:', error);
        // é¡¯ç¤ºéŒ¯èª¤ç‹€æ…‹
        const networkStatus = document.querySelector('#sync-network-status .status-value');
        networkStatus.textContent = 'éŒ¯èª¤';
        networkStatus.className = 'status-value status-error';

        const queueStatus = document.querySelector('#sync-queue-status .status-value');
        queueStatus.textContent = 'éŒ¯èª¤';
        queueStatus.className = 'status-value status-error';

        const bufferStatus = document.querySelector('#sync-buffer-status .status-value');
        bufferStatus.textContent = 'éŒ¯èª¤';
        bufferStatus.className = 'status-value status-error';
    }
}

// è¨»å†Šç¤ºç¯„æ©Ÿå™¨äºº
async function registerDemoRobot() {
    try {
        const res = await fetch('/api/edge/robots', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name: 'Demo Robot ' + Date.now(),
                type: 'humanoid',
                capabilities: [
                    'go_forward', 'back_fast', 'turn_left', 'turn_right',
                    'stand', 'bow', 'wave', 'dance_two'
                ]
            })
        });
        
        const data = await res.json();
        if (data.success) {
            window.EdgeUI.showToast('æ©Ÿå™¨äººè¨»å†ŠæˆåŠŸ: ' + data.robot.name);
            refreshStatus();
        }
    } catch (error) {
        console.error('Failed to register robot:', error);
        window.EdgeUI.showToast('è¨»å†Šå¤±æ•—', 'error');
    }
}

// æ›´æ–°é€£ç·šç‹€æ…‹æŒ‡ç¤ºå™¨
function updateConnectionStatus(data) {
    const indicator = document.getElementById('connection-status');
    if (data.local_llm_available && data.internet_available) {
        indicator.textContent = 'âœ… å®Œå…¨é€£ç·š';
        indicator.className = 'status-indicator status-success';
    } else if (data.local_llm_available || data.internet_available) {
        indicator.textContent = 'âš ï¸ éƒ¨åˆ†é€£ç·š';
        indicator.className = 'status-indicator status-warning';
    } else {
        indicator.textContent = 'âŒ é›¢ç·šæ¨¡å¼';
        indicator.className = 'status-indicator status-error';
    }
}
</script>
{% endblock %}
