# 離線模式模組設計分析

> **Phase 3.2 功能**：離線模式完善與斷線處理
> **建立日期**：2025-12-04
> **狀態**：設計完成

---

## 系統架構概覽

### 元件分佈

```
┌─────────────────────────────────────────────────────────────────┐
│                MCP Client + LLM Provider                         │
│                (可能在雲端或遠端位置)                             │
│                                                                  │
│  • LLM Provider (Ollama/OpenAI/Claude/etc.)                     │
│  • MCP Client (發送指令到 MCP Server)                           │
│  • 使用者介面 / 自動化系統                                       │
└─────────────────────────────────────────────────────────────────┘
                              ↓ ↑
              [網路連接 - 可能離線（離線場景 A）]
                              ↓ ↑
┌─────────────────────────────────────────────────────────────────┐
│                         Edge 層                                  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                      MCP Server                            │  │
│  │                    (在 Edge 運行)                          │  │
│  │                                                           │  │
│  │  • 接收來自 MCP Client 的指令                             │  │
│  │  • 本地指令佇列管理                                        │  │
│  │  • 離線時緩衝指令                                          │  │
│  └───────────────────────────────────────────────────────────┘  │
│                              ↓                                   │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │              OfflineQueueService                           │  │
│  │                                                           │  │
│  │   ┌─────────────────┐      ┌─────────────────────────┐   │  │
│  │   │ 本地離線佇列    │←─────│ 網路佇列代理            │   │  │
│  │   │ (SQLite)        │      │ (Redis/RabbitMQ Client) │   │  │
│  │   │                 │      │                         │   │  │
│  │   │ • 佇列不可用時  │      │ • 可用時直接發送       │   │  │
│  │   │   緩衝指令      │─────▶│ • 恢復時同步緩衝       │   │  │
│  │   └─────────────────┘      └───────────┬─────────────┘   │  │
│  │                                        │                  │  │
│  └────────────────────────────────────────┼──────────────────┘  │
│                                           ↓                     │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │              網路佇列服務 (Redis/RabbitMQ)                 │  │
│  │              ↑ 可能透過網路（離線場景 B）↑                │  │
│  └───────────────────────────────────────────────────────────┘  │
│                              ↓                                   │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                     Runner（執行器）                       │  │
│  │                  從佇列接收並執行指令                      │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 離線場景分析

### 離線場景 A：MCP Client 與 MCP Server 之間

**情況**：LLM Provider + MCP Client 在遠端，與 Edge 上的 MCP Server 網路斷開

**影響**：
- 無法接收來自 LLM 的新指令
- 已在 Edge 緩衝的指令仍可執行
- 執行結果無法即時回報給 MCP Client

**處理方式**：
- MCP Server 維持本地運作
- 緩衝執行結果，網路恢復後同步
- 支援本地預設指令（如果有）

### 離線場景 B：MCP Server 與網路佇列服務之間

**情況**：Edge 內部的網路佇列服務（Redis/RabbitMQ）不可用

**影響**：
- 無法將指令發送到佇列
- Runner 無法接收新指令

**處理方式**：
- 使用本地 SQLite 緩衝指令
- 佇列服務恢復後自動同步
- 保持指令順序和優先權

### 離線場景 C：完全離線

**情況**：A + B 同時發生

**處理方式**：
- 本地緩衝所有待執行指令
- 本地緩衝所有執行結果
- 服務恢復後按順序同步

---

## 模組設計

### 模組 1: 網路監控器 (Network Monitor)

監控對象：
- MCP Client 連線狀態（離線場景 A）
- 網路佇列服務連線狀態（離線場景 B）

### 模組 2: 離線指令緩衝 (Offline Command Buffer)

使用 SQLite 持久化，處理佇列服務不可用的情況：
- 佇列服務不可用時緩衝指令
- 保持指令順序和優先權
- 佇列服務恢復時自動同步

### 模組 3: 結果同步緩衝 (Result Sync Buffer)

使用 SQLite 持久化，處理 MCP Client 離線：
- 緩衝執行結果
- MCP Client 恢復連線後同步
- 支援批次同步

### 模組 4: 連線管理器 (Connection Manager)

管理與各服務的連線：
- 自動重連機制
- 指數退避策略
- 健康檢查

---

## 整合架構

### OfflineQueueService 設計

```python
class OfflineQueueService:
    """
    離線佇列服務
    
    處理兩種離線場景：
    
    1. 指令緩衝（佇列服務不可用）：
       - 佇列服務可用：直接發送到網路佇列
       - 佇列服務不可用：緩衝到本地 SQLite
       - 佇列服務恢復：自動同步緩衝指令
    
    2. 結果同步（MCP Client 離線）：
       - MCP Client 在線：直接回報結果
       - MCP Client 離線：緩衝結果
       - MCP Client 恢復：批次同步結果
    """
```

### 指令流程

```
MCP Client + LLM Provider
      ↓ [可能離線]
┌──────────────────────────────────┐
│        MCP Server (Edge)         │
│              ↓                   │
│    OfflineQueueService           │
│              ↓                   │
│    檢查佇列服務是否可用          │
│         ↓          ↓             │
│      [可用]     [不可用]         │
│         ↓          ↓             │
│    發送到      緩衝到本地        │
│    網路佇列    SQLite 佇列       │
│         ↓          │             │
│         └──────────┤             │
│                    ↓             │
│            [佇列服務恢復]        │
│            同步緩衝指令          │
└──────────────────────────────────┘
      ↓
網路佇列服務 (Redis/RabbitMQ)
      ↓
Runner 從佇列接收並執行
      ↓
執行結果
      ↓
┌──────────────────────────────────┐
│        結果同步                  │
│         ↓          ↓             │
│   [Client在線] [Client離線]      │
│         ↓          ↓             │
│    直接回報    緩衝結果          │
│         ↓          │             │
│         └──────────┤             │
│                    ↓             │
│          [Client恢復連線]        │
│            批次同步結果          │
└──────────────────────────────────┘
      ↓
MCP Client + LLM Provider
```

---

## 關鍵場景

### 場景 1：完全在線
```
MCP Client → MCP Server → 網路佇列 → Runner → 執行 → 結果回報 → MCP Client
```

### 場景 2：MCP Client 離線（離線場景 A）
```
[無法接收新指令]
執行結果 → 緩衝到本地 → [Client 恢復] → 批次同步結果
```

### 場景 3：佇列服務不可用（離線場景 B）
```
MCP Client → MCP Server → 本地 SQLite 緩衝
                            ↓
                      [佇列服務恢復]
                            ↓
                    網路佇列 → Runner → 執行
```

### 場景 4：完全離線（A + B）
```
[無法接收新指令]
本地緩衝的指令 → 等待佇列服務恢復 → 網路佇列 → Runner → 執行
執行結果 → 緩衝到本地 → [Client 恢復] → 批次同步結果
```

---

## 選擇結論

| 模組 | 選擇方案 | 理由 |
|------|---------|------|
| **網路監控器** | 服務健康檢查 + 連線狀態監控 | 監控多個連線點 |
| **指令緩衝** | SQLite 持久化 | 指令不應丟失 |
| **結果同步緩衝** | SQLite 持久化 | 支援長時間離線 |
| **連線管理器** | 指數退避重連 | 避免服務壓力 |

### 關鍵設計決策

1. **MCP Server 在 Edge**：減少對外部 LLM 的即時依賴
2. **LLM Provider 與 MCP Client 共置**：LLM 處理在遠端進行
3. **雙層離線緩衝**：
   - 指令緩衝：處理佇列服務不可用
   - 結果緩衝：處理 MCP Client 離線
4. **SQLite 持久化**：確保指令和結果不丟失

---

**文件維護者**：開發團隊  
**最後更新**：2025-12-04
