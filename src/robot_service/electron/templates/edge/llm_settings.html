{% extends "edge/base.html" %}

{% block title %}LLM è¨­å®š{% endblock %}

{% block content %}
<div class="page-header">
    <h1>ğŸ§  LLM è¨­å®š</h1>
    <p class="subtitle">ç®¡ç†æœ¬åœ° LLM æä¾›å•†</p>
</div>

<!-- é€£ç·šç‹€æ…‹ -->
<div class="section">
    <h2>ğŸ“¡ é€£ç·šç‹€æ…‹</h2>
    <div class="status-grid">
        <div class="status-card" id="internet-status-card">
            <span class="status-icon">ğŸŒ</span>
            <span class="status-label">ç¶²è·¯é€£ç·š</span>
            <span id="internet-status" class="status-value status-checking">æª¢æŸ¥ä¸­...</span>
        </div>
        <div class="status-card" id="mcp-status-card">
            <span class="status-icon">â˜ï¸</span>
            <span class="status-label">MCP ä¼ºæœå™¨</span>
            <span id="mcp-status" class="status-value status-checking">æª¢æŸ¥ä¸­...</span>
        </div>
        <div class="status-card" id="llm-status-card">
            <span class="status-icon">ğŸ§ </span>
            <span class="status-label">æœ¬åœ° LLM</span>
            <span id="llm-status" class="status-value status-checking">æª¢æŸ¥ä¸­...</span>
        </div>
    </div>
</div>

<!-- LLM æä¾›å•†åˆ—è¡¨ -->
<div class="section">
    <h2>ğŸ”Œ LLM æä¾›å•†</h2>
    <div class="toolbar">
        <button class="btn btn-primary" onclick="discoverProviders()">
            ğŸ” æƒææä¾›å•†
        </button>
        <button class="btn btn-secondary" onclick="refreshStatus()">
            ğŸ”„ é‡æ–°æ•´ç†
        </button>
    </div>
    
    <div id="providers-container" class="providers-list">
        <div class="loading">æ­£åœ¨è¼‰å…¥...</div>
    </div>
</div>

<!-- ä½¿ç”¨èªªæ˜ -->
<div class="section">
    <h2>ğŸ“– ä½¿ç”¨èªªæ˜</h2>
    <div class="info-grid">
        <div class="info-card">
            <h4>ğŸ¦™ Ollama</h4>
            <p>é è¨­ç«¯å£ï¼š11434</p>
            <p>å®‰è£ï¼š<code>curl -fsSL https://ollama.ai/install.sh | sh</code></p>
            <a href="https://ollama.ai" target="_blank" class="btn btn-sm btn-info">
                å®˜æ–¹ç¶²ç«™ â†—
            </a>
        </div>
        <div class="info-card">
            <h4>ğŸ¨ LM Studio</h4>
            <p>é è¨­ç«¯å£ï¼š1234</p>
            <p>ä¸‹è¼‰å¾Œå•Ÿå‹•æœ¬åœ°ä¼ºæœå™¨åŠŸèƒ½</p>
            <a href="https://lmstudio.ai" target="_blank" class="btn btn-sm btn-info">
                å®˜æ–¹ç¶²ç«™ â†—
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// é é¢è¼‰å…¥æ™‚æª¢æŸ¥ç‹€æ…‹
document.addEventListener('DOMContentLoaded', function() {
    refreshStatus();
});

// é‡æ–°æ•´ç†ç‹€æ…‹
async function refreshStatus() {
    try {
        const res = await fetch('/api/edge/llm/status');
        const data = await res.json();
        
        // æ›´æ–°ç¶²è·¯ç‹€æ…‹
        const internetStatus = document.getElementById('internet-status');
        if (data.internet_available) {
            internetStatus.textContent = 'å·²é€£ç·š';
            internetStatus.className = 'status-value status-success';
        } else {
            internetStatus.textContent = 'é›¢ç·š';
            internetStatus.className = 'status-value status-warning';
        }
        
        // æ›´æ–° MCP ç‹€æ…‹
        const mcpStatus = document.getElementById('mcp-status');
        if (data.mcp_available) {
            mcpStatus.textContent = 'é‹è¡Œä¸­';
            mcpStatus.className = 'status-value status-success';
        } else {
            mcpStatus.textContent = 'æœªé€£ç·š';
            mcpStatus.className = 'status-value status-error';
        }
        
        // æ›´æ–° LLM ç‹€æ…‹
        const llmStatus = document.getElementById('llm-status');
        if (data.local_llm_available) {
            llmStatus.textContent = 'å¯ç”¨';
            llmStatus.className = 'status-value status-success';
        } else {
            llmStatus.textContent = 'ä¸å¯ç”¨';
            llmStatus.className = 'status-value status-error';
        }
        
        // æ¸²æŸ“æä¾›å•†åˆ—è¡¨
        renderProviders(data.local_llm_providers || []);
        
    } catch (error) {
        console.error('Failed to refresh status:', error);
    }
}

// æƒææä¾›å•†
async function discoverProviders() {
    const container = document.getElementById('providers-container');
    container.innerHTML = '<div class="loading">æ­£åœ¨æƒæ...</div>';
    
    try {
        const res = await fetch('/api/edge/llm/providers');
        const data = await res.json();
        renderProviders(data.providers || []);
    } catch (error) {
        console.error('Failed to discover providers:', error);
        container.innerHTML = '<div class="error">æƒæå¤±æ•—</div>';
    }
}

// æ¸²æŸ“æä¾›å•†åˆ—è¡¨
function renderProviders(providers) {
    const container = document.getElementById('providers-container');
    
    if (providers.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">ğŸ”</div>
                <h3>æœªæ‰¾åˆ° LLM æä¾›å•†</h3>
                <p>è«‹ç¢ºä¿ Ollama æˆ– LM Studio æ­£åœ¨é‹è¡Œï¼Œç„¶å¾Œé»æ“Šã€Œæƒææä¾›å•†ã€</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = providers.map(provider => `
        <div class="provider-card status-${provider.status}">
            <div class="provider-header">
                <span class="provider-icon">${provider.name === 'ollama' ? 'ğŸ¦™' : 'ğŸ¨'}</span>
                <h3 class="provider-name">${provider.display_name}</h3>
                <span class="provider-status status-${provider.status}">
                    ${provider.status === 'available' ? 'âœ… å¯ç”¨' : 'âŒ ä¸å¯ç”¨'}
                </span>
            </div>
            <div class="provider-body">
                <div class="info-row">
                    <span class="info-label">ç«¯é»</span>
                    <span class="info-value">${provider.endpoint}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">å¯ç”¨æ¨¡å‹</span>
                    <span class="info-value">${provider.models ? provider.models.length : 0} å€‹</span>
                </div>
                ${provider.models && provider.models.length > 0 ? `
                <div class="models-list">
                    ${provider.models.slice(0, 5).map(m => `
                        <span class="model-tag">${m}</span>
                    `).join('')}
                    ${provider.models.length > 5 ? `<span class="model-tag">+${provider.models.length - 5} æ›´å¤š</span>` : ''}
                </div>
                ` : ''}
            </div>
            <div class="provider-actions">
                <button class="btn btn-sm btn-primary" onclick="selectProvider('${provider.name}')">
                    é¸æ“‡æ­¤æä¾›å•†
                </button>
            </div>
        </div>
    `).join('');
}

// é¸æ“‡æä¾›å•†
async function selectProvider(providerName) {
    try {
        const res = await fetch('/api/edge/settings', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ llm_provider: providerName })
        });
        
        const data = await res.json();
        if (data.success) {
            showToast(`å·²é¸æ“‡ ${providerName} ä½œç‚º LLM æä¾›å•†`, 'success');
        } else {
            showToast('é¸æ“‡å¤±æ•—', 'error');
        }
    } catch (error) {
        console.error('Failed to select provider:', error);
        showToast('é¸æ“‡å¤±æ•—', 'error');
    }
}

// é¡¯ç¤ºæç¤ºè¨Šæ¯
function showToast(message, type = 'success', duration = 3000) {
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, duration);
}
</script>
{% endblock %}
