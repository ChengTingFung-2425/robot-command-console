# 安全檢查清單 (Security Checklist)

本文件提供 Robot Command Console 系統的安全檢查清單，用於開發、部署和維護階段。

## 開發階段

### 認證和授權
- [x] 所有 API 端點（除了 `/health` 和 `/metrics`）都需要認證
- [x] JWT token 包含過期時間
- [x] Token 過期時間可配置（預設 24 小時）
- [x] 實施 token rotation 端點
- [x] 密碼使用 bcrypt 雜湊（包含隨機鹽值）
- [x] 實施基於角色的存取控制 (RBAC)
- [x] 定義三種角色：admin、operator、viewer
- [x] 每個操作都檢查權限
- [x] 預設使用最低權限角色（viewer）
- [ ] 實施速率限制防止暴力破解（建議）
- [ ] 實施登入失敗鎖定機制（建議）
- [ ] 實施 refresh token 機制（建議）

### 輸入驗證
- [x] 使用 Pydantic 驗證所有 API 輸入
- [x] 使用 JSON Schema 驗證指令請求
- [x] 驗證所有使用者輸入長度和格式
- [x] 白名單允許的動作和參數
- [x] 驗證機器人能力與請求的動作匹配
- [x] 對 SQL 查詢使用參數化（SQLAlchemy ORM）
- [x] 防止路徑遍歷攻擊（使用絕對路徑）

### 資料保護
- [x] 密碼從不以明文形式記錄
- [x] JWT Secret 從環境變數讀取
- [x] APP_TOKEN 從環境變數讀取
- [x] 實施秘密儲存抽象層
- [x] 提供多種秘密儲存後端（檔案、keychain、dpapi）
- [x] 錯誤訊息不洩露敏感資訊
- [x] 敏感欄位不出現在日誌中
- [ ] 生產環境使用外部秘密管理服務（建議）

### API 安全
- [x] OpenAPI 規範文件化所有公開端點
- [x] API 使用版本控制（/v1 前綴）
- [x] 實施 CORS 政策
- [x] 明確定義錯誤回應格式
- [x] 所有回應包含適當的 HTTP 狀態碼
- [x] 實施請求追蹤（correlation ID、trace ID）
- [ ] 生產環境強制使用 HTTPS（部署時）

### 審計和日誌
- [x] 使用結構化 JSON 日誌格式
- [x] 記錄所有認證嘗試（成功和失敗）
- [x] 記錄所有權限檢查失敗
- [x] 記錄所有敏感操作到審計日誌
- [x] 日誌包含 timestamp、level、event、service
- [x] 所有請求包含 correlation ID 和 trace ID
- [x] 審計事件包含 user_id、action、context
- [x] 審計日誌資料模型已建立（AuditLog）
- [x] 審計日誌查詢介面已實作（/audit_logs）
- [x] 審計日誌 CSV 匯出功能已實作
- [x] 審計日誌權限控管（僅 admin/auditor）
- [ ] 集中式日誌管理（建議）
- [ ] 日誌完整性檢查（建議）

### 錯誤處理
- [x] 統一的錯誤回應格式
- [x] 錯誤訊息不洩露內部實作細節
- [x] 區分不同的錯誤類型（400、401、403、404、500）
- [x] 記錄所有錯誤到日誌
- [x] 錯誤計數器（Prometheus metrics）

### 資源管理
- [x] 實施指令超時機制（預設 10 秒，可配置）
- [x] 佇列大小限制（預設 1000）
- [x] 工作者數量限制（預設 5，可配置）
- [x] 監控 WebSocket 連線數
- [x] 實施連線超時
- [ ] 記憶體和 CPU 使用限制（建議）

### 程式碼品質
- [x] 輸入驗證覆蓋率測試
- [x] 認證和授權測試
- [x] Token 過期測試
- [x] 權限檢查測試
- [x] 審計日誌測試
- [x] 錯誤處理測試
- [ ] 安全程式碼掃描（建議整合 SAST 工具）
- [ ] 依賴漏洞掃描（建議整合 SCA 工具）

## 測試階段

### 單元測試
- [x] AuthManager 所有功能測試
- [x] Token 建立和驗證測試
- [x] 過期 token 拒絕測試
- [x] 無效 token 拒絕測試
- [x] 權限檢查測試（所有角色）
- [x] 密碼雜湊和驗證測試
- [x] 審計日誌記錄測試

### 整合測試
- [x] 完整認證流程測試
- [x] Token rotation 測試
- [x] 端到端指令執行測試（包含認證）
- [x] 權限不足拒絕測試
- [x] 合約驗證測試

### 安全測試
- [x] 未認證請求拒絕測試
- [x] 過期 token 拒絕測試
- [x] 無效 token 拒絕測試
- [x] 權限提升嘗試拒絕測試
- [x] 輸入驗證失敗測試
- [ ] 滲透測試（建議用於生產環境）
- [ ] 模糊測試（建議）

### 效能測試
- [ ] 負載測試（建議）
- [ ] 壓力測試（建議）
- [ ] DoS 抵抗測試（建議）

## 部署階段

### 環境配置
- [ ] 使用強健的 JWT_SECRET（至少 32 字元隨機字串）
- [ ] 使用強健的 APP_TOKEN（至少 32 字元隨機字串）
- [ ] 秘密從環境變數或秘密管理服務載入
- [ ] 秘密不提交到版本控制
- [ ] 不同環境使用不同的秘密
- [ ] 定期輪替秘密
- [ ] 最小權限運行服務（非 root 使用者）

### 網路安全
- [ ] 生產環境強制使用 HTTPS
- [ ] 配置適當的 CORS 政策
- [ ] 使用防火牆限制入站流量
- [ ] 只暴露必要的端點
- [ ] 使用反向代理（nginx、HAProxy）
- [ ] 實施速率限制（在反向代理層級）
- [ ] DDoS 防護（CloudFlare 或類似服務）

### 監控和警報
- [x] Prometheus metrics 端點已啟用
- [ ] 設定 Prometheus 抓取 metrics
- [ ] 設定 Grafana 儀表板
- [ ] 配置警報規則：
  - [ ] 高錯誤率警報
  - [ ] 認證失敗警報
  - [ ] 異常流量警報
  - [ ] 服務不可用警報
- [ ] 集中式日誌收集（ELK、Loki 或類似）
- [ ] 日誌保留政策（至少 90 天）

### 備份和恢復
- [ ] 定期備份資料庫
- [ ] 測試恢復程序
- [ ] 備份加密
- [ ] 異地備份
- [ ] 文件化恢復程序

### 合規性
- [ ] 審查資料保護法規（GDPR、CCPA 等）
- [ ] 實施資料保留政策
- [ ] 使用者同意機制（如適用）
- [ ] 資料主體權利實施（如適用）
- [ ] 隱私政策和服務條款

## 維護階段

### 定期檢查
- [ ] 每週檢查安全警報和日誌
- [ ] 每月審查使用者權限
- [ ] 每季度審查威脅模型
- [ ] 每季度進行安全掃描
- [ ] 每半年進行滲透測試

### 更新和修補
- [ ] 定期更新所有依賴套件
- [ ] 訂閱安全公告郵件列表
- [ ] 建立漏洞回應程序
- [ ] 測試補丁後再部署
- [ ] 文件化更新程序

### 事件回應
- [ ] 建立安全事件回應計劃
- [ ] 定義嚴重性等級
- [ ] 指定回應團隊和聯絡人
- [ ] 定期演練事件回應程序
- [ ] 文件化事件回應程序

### 存取管理
- [ ] 定期審查使用者帳號
- [ ] 移除離職員工的存取權限
- [ ] 實施最小權限原則
- [ ] 定期輪替秘密和憑證
- [ ] 審計管理員操作

## OpenAPI 驗證

### 規範維護
- [x] OpenAPI 規範已建立（openapi.yaml）
- [x] 所有公開端點已文件化
- [x] 定義版本控制策略
- [x] 安全方案已定義
- [ ] 與程式碼保持同步
- [ ] CI 中驗證規範有效性

### 請求/回應驗證
- [ ] 在服務中實施 OpenAPI 請求驗證
- [ ] 在服務中實施 OpenAPI 回應驗證
- [ ] 驗證失敗時返回明確錯誤
- [ ] CI 中執行合約測試

## 秘密管理

### 儲存
- [x] 秘密儲存抽象介面已實施
- [x] 檔案型儲存已實施
- [x] Keychain 儲存 stub 已實施
- [x] DPAPI 儲存 stub 已實施
- [ ] 生產環境使用外部秘密管理（AWS Secrets Manager、HashiCorp Vault 等）

### 使用
- [x] 秘密從配置或環境變數載入
- [x] 秘密不硬編碼在程式碼中
- [x] 秘密不記錄到日誌
- [x] 秘密在記憶體中使用完後清除（盡力而為）
- [ ] 實施秘密輪替程序

## CI/CD 安全

### 持續整合
- [ ] 在 CI 中執行安全測試
- [ ] 在 CI 中執行依賴漏洞掃描
- [ ] 在 CI 中執行 OpenAPI 驗證
- [ ] 在 CI 中執行靜態程式碼分析
- [ ] 失敗時阻止合併

### 持續部署
- [ ] 自動化部署程序
- [ ] 部署前執行安全檢查
- [ ] 使用不可變基礎設施
- [ ] 實施藍綠部署或金絲雀發布
- [ ] 快速回滾機制

## 文件

### 安全文件
- [x] 威脅模型已建立（threat-model.md）
- [x] 安全檢查清單已建立（本文件）
- [x] OpenAPI 規範已建立（openapi.yaml）
- [ ] 安全架構圖
- [ ] 資料流圖
- [ ] 事件回應計劃
- [ ] 恢復程序文件

### 使用者文件
- [ ] 認證和授權使用指南
- [ ] API 使用範例
- [ ] 安全最佳實踐
- [ ] 常見問題解答

## 檢查清單使用說明

### 符號說明
- [x] 已實施
- [ ] 未實施或建議實施
- ⚠️ 部分實施或需要注意

### 使用建議
1. 在開發新功能前檢查相關項目
2. 在程式碼審查時參考此清單
3. 在部署前確認所有部署相關項目
4. 定期審查並更新此清單
5. 在安全事件後審查相關項目

## 下一步行動

### 優先級 1（立即）
- [ ] 生產環境配置強健的秘密
- [ ] 設定 HTTPS
- [ ] 配置監控和警報

### 優先級 2（短期）
- [ ] 實施速率限制
- [ ] 實施 OpenAPI 請求/回應驗證
- [ ] 整合集中式日誌管理
- [x] 實作審計日誌系統（已完成）

### 優先級 3（長期）
- [ ] 實施 refresh token 機制
- [ ] 整合外部秘密管理服務
- [ ] 進行滲透測試
- [ ] 實施進階 DoS 防護
- [ ] 審計日誌完整性驗證
- [ ] 登入失敗自動鎖定機制

## 審查歷史

| 日期 | 版本 | 審查者 | 變更說明 |
|------|------|--------|----------|
| 2025-11-20 | 1.0 | System | 初始版本 |
| 2025-12-17 | 1.1 | System | 新增審計日誌系統實作記錄 |

## 參考資源

- [OWASP Application Security Verification Standard](https://owasp.org/www-project-application-security-verification-standard/)
- [OWASP API Security Top 10](https://owasp.org/www-project-api-security/)
- [CIS Security Benchmarks](https://www.cisecurity.org/cis-benchmarks/)
- [NIST Cybersecurity Framework](https://www.nist.gov/cyberframework)
