{% extends "base.html.j2" %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/robot_dashboard.css') }}">
{% endblock %}

{% block app_content %}
<h2>機器人儀表板</h2>
<div class="row">
  {% for robot in robots %}
  <div class="col-md-6 col-lg-4">
    <div class="panel panel-default robot-card" onclick="window.location.href='{{ url_for('webui.media_stream', robot_id=robot.id) }}'">
      <div class="panel-heading">
        <strong>{{ robot.name }}</strong>
        <span class="pull-right">
          <span class="label label-{{ 'success' if robot.status == 'online' else 'warning' if robot.status == 'idle' else 'danger' }}">
            {{ robot.status }}
          </span>
        </span>
      </div>
      <div class="panel-body" style="padding: 0;">
        <!-- 影片串流預覽 -->
        <div class="video-feed-container">
          <canvas id="robot-video-{{ robot.id }}" class="video-feed-canvas"></canvas>
          <div class="video-placeholder" id="placeholder-{{ robot.id }}">
            <i class="glyphicon glyphicon-facetime-video" style="font-size: 48px;"></i>
            <p>等待視訊串流...</p>
          </div>
        </div>
        
        <!-- 機器人資訊 -->
        <div class="robot-info">
          <div style="margin-bottom: 8px;">
            <strong>類型：</strong>{{ robot.type }}
          </div>
          
          <!-- 電池電量 -->
          <div style="margin-bottom: 8px;">
            <strong>電量：</strong>
            <div class="battery-indicator">
              {% set battery_level = robot.battery if robot.battery is not None else 100 %}
              <div class="battery-level {{ 'high' if battery_level > 50 else 'medium' if battery_level > 20 else 'low' }}" 
                   style="width: {{ battery_level }}%;"></div>
            </div>
            <span style="margin-left: 5px;">{{ battery_level }}%</span>
          </div>
          
          <!-- 位置資訊 -->
          {% if robot.location %}
          <div style="margin-bottom: 8px;">
            <strong>位置：</strong>{{ robot.location }}
          </div>
          {% endif %}
          
          <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd;">
            <small class="text-muted">
              <i class="glyphicon glyphicon-hand-up"></i> 點擊查看完整狀態
            </small>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}
</div>

{% if not robots %}
<div class="alert alert-info">
  <p>您還沒有註冊任何機器人。</p>
  <a href="{{ url_for('webui.register_robot') }}" class="btn btn-primary">註冊機器人</a>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/robot_dashboard.js') }}"></script>
<script>
// Initialize video streams for all robots on page load
document.addEventListener('DOMContentLoaded', function() {
  const robotIds = [{% for robot in robots %}{{ robot.id }}{% if not loop.last %}, {% endif %}{% endfor %}];
  initRobotVideoStreams(robotIds);
});
</script>
{% endblock %}
